{% extends "base.html" %}
{% load civil_extras %}
{% block content %}

<!-- PREMIUM PAGE BACKDROP -->

<div class="fixed inset-0 -z-10 bg-gradient-to-br
            from-slate-50 via-white to-amber-50"></div>

<div class="max-w-7xl mx-auto px-4 py-6 space-y-8 animate-page">

  <!-- ================= HEADER ================= -->

  <div class="premium-header">


<div>
  <h2 class="text-2xl font-extrabold text-slate-900 flex items-center gap-2 flex-wrap">
    üèó

    <div class="min-w-[220px]">
      <select id="siteSwitcher"
              onchange="switchSite()"
              class="site-switcher">

        {% for s in sites %}
          <option value="{{ s.id }}"
            {% if s.id == site.id %}selected{% endif %}>
            {{ s.name }}
          </option>
        {% endfor %}

      </select>
    </div>

    <span class="text-slate-500 font-bold">‚Äì Daily Entry</span>
  </h2>

  <p class="text-sm text-gray-500 mt-1">
    Enter labour, advances and materials
  </p>
</div>

<div class="flex items-center gap-3 flex-wrap justify-between">
  <input type="date"
         id="work_date"
         value="{{ work_date|date:'Y-m-d' }}"
         onchange="goToEdit({{ site.id }})"
         class="date-input-modern">

  <!-- RESET -->
  <div class="relative">
    <button onclick="toggleResetMenu({{ site.id }})"
            class="reset-btn-modern">
      Reset ‚ñæ
    </button>

    <div id="resetMenu{{ site.id }}"
         class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border z-50">
      <a href="{% url 'reset_site_today' site.id %}"
         onclick="return confirm('Reset today entries?')"
         class="reset-link">üîÑ Reset Today</a>

      <a href="{% url 'reset_site_month' site.id %}"
         onclick="return confirm('Reset this month entries?')"
         class="reset-link">üìÖ Reset Month</a>

      <a href="#"
         onclick="resetByDate({{ site.id }})"
         class="reset-link text-orange-600">
        üìÜ Reset Selected Date
      </a>

      <div class="border-t"></div>

      <a href="{% url 'reset_site_all' site.id %}"
         onclick="return confirm('Delete ALL entries?')"
         class="reset-link text-red-600 font-semibold">
        üóë Reset All
      </a>
    </div>
  </div>

  <!-- SMART COPY -->
  <button type="button"
          onclick="openCopyModal({{ site.id }})"
          class="btn-green-modern">
    üìã Smart Copy
  </button>
  <!-- ===== INLINE TOTAL ===== -->
<div id="liveTotalBar" class="inline-total">

  <span class="inline-total-label">
    üí∞ Total
  </span>

  <span id="liveGrandTotal" class="inline-total-amount">
    ‚Çπ0
  </span>

</div>
</div>


  </div>

  <!-- ================= DAILY DESCRIPTION ================= -->

  <div id="descPreviewCard" class="glass-card p-4">
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-xs font-bold text-indigo-600 tracking-wide">
          üìù DAILY NOTE
        </p>


    <p id="descPreviewText"
       class="text-sm text-slate-700 font-medium mt-1 whitespace-pre-line">
      {{ daily_description|default_if_none:""|default:"No description added for this day." }}
    </p>
  </div>

  <button type="button"
          onclick="openDescModal()"
          class="chip-btn">
    Edit
  </button>
</div>


  </div>

  <!-- ===== LIVE TOTAL BAR ===== -->

  

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="date" value="{{ work_date|date:'Y-m-d' }}">
    <input type="hidden" name="daily_description" id="daily_description_input"
           value="{{ daily_description|default:'' }}">


{% include "site/partials/_civil_section.html" %}
{% include "site/partials/_dept_section.html" %}
{% include "site/partials/_material_section.html" %}
{% include "site/partials/_expense_section.html" %}

<button type="submit" class="save-btn w-full">
  {% if request.GET.date %} üîÑ Update Entries {% else %} ‚úÖ Save Entries {% endif %}
</button>


  </form>
</div>
<!-- ================= DESCRIPTION MODAL ================= -->
<div id="descModal"
     class="hidden fixed inset-0 z-50 items-center justify-center bg-black/40 backdrop-blur-sm">

  <div class="modal-card w-full max-w-lg">

    <!-- header -->
    <div class="modal-head">
      <h3>üìù Daily Description</h3>
      <button type="button" onclick="closeDescModal()" class="modal-close">‚úï</button>
    </div>

    <!-- body -->
    <div class="p-4">
      <textarea id="daily_description_text"
                rows="5"
                class="modal-textarea"
                placeholder="Enter today work description..."></textarea>
    </div>

    <!-- footer -->
    <div class="modal-footer">
      <button type="button"
              onclick="closeDescModal()"
              class="modal-btn cancel">
        Cancel
      </button>

      <button type="button"
              onclick="saveDescription()"
              class="modal-btn save">
        Save
      </button>
    </div>

  </div>
</div>

<!-- ================= SMART COPY MODAL ================= -->
<div id="copyModal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">

  <div class="modal-card w-full max-w-md">

    <!-- header -->
    <div class="modal-head">
      <h3>üìã Smart Copy</h3>
      <button type="button" onclick="closeCopyModal()" class="modal-close">‚úï</button>
    </div>

    <!-- body -->
    <div class="p-4 space-y-3 text-sm font-semibold text-slate-700">

      <label class="modal-check">
        <input type="checkbox" id="copyCivil" checked>
        Civil Labour
      </label>

      <label class="modal-check">
        <input type="checkbox" id="copyDept" checked>
        Department Labour
      </label>

      <label class="modal-check">
        <input type="checkbox" id="copyMaterial" checked>
        Materials
      </label>

      <label class="modal-check">
        <input type="checkbox" id="copyDesc">
        Daily Description
      </label>

      <label class="modal-check text-red-600">
        <input type="checkbox" id="copyReplace">
        Replace today if exists
      </label>

    </div>

    <!-- footer -->
    <div class="modal-footer">
      <button type="button"
              onclick="closeCopyModal()"
              class="modal-btn cancel">
        Cancel
      </button>

      <button type="button"
              onclick="runSmartCopy()"
              class="modal-btn save">
        Copy Now
      </button>
    </div>

  </div>
</div>
<!-- ================= STYLES ================= -->

<style>
  /* ===== INLINE HEADER TOTAL ===== */
.inline-total{
  display:flex;
  align-items:center;
  gap:8px;
  padding:.4rem .7rem;
  border-radius:10px;
  border:1px solid #fde68a;
  background:linear-gradient(135deg,#ffffff,#fffdf5);
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  font-weight:800;
}

.inline-total-label{
  font-size:.75rem;
  color:#a16207;
  white-space:nowrap;
}

.inline-total-amount{
  font-size:.95rem;
  color:#166534;
  font-weight:900;
  letter-spacing:.3px;
}

/* small screens */
@media (max-width:640px){
  .inline-total{
    padding:.35rem .6rem;
  }
}
/* ===== MODAL CHECK ROW ===== */
.modal-check{
  display:flex;
  align-items:center;
  gap:10px;
  padding:6px 4px;
  border-radius:8px;
  font-size:.9rem;
  font-weight:600;
  color:#334155;
  cursor:pointer;
  transition:.15s ease;
}

.modal-check:hover{
  background:#f8fafc;
}

/* checkbox size */
.modal-check input[type="checkbox"]{
  width:16px;
  height:16px;
  accent-color:#22c55e; /* green tick */
  cursor:pointer;
}
:root{
  --accent:#facc15;
  --accent-strong:#f59e0b;
}
/* ===== GREEN ACTION BUTTON ===== */
.btn-green-modern{
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:white;
  font-size:.85rem;
  font-weight:800;
  padding:.45rem .9rem;
  border-radius:.6rem;
  box-shadow:0 6px 16px rgba(34,197,94,.35);
  transition:all .2s ease;
  display:inline-flex;
  align-items:center;
  gap:4px;
}

.btn-green-modern:hover{
  background:linear-gradient(135deg,#16a34a,#15803d);
  transform:translateY(-1px);
  box-shadow:0 10px 22px rgba(34,197,94,.45);
}

.btn-green-modern:active{
  transform:translateY(0);
  box-shadow:0 4px 10px rgba(34,197,94,.35);
}
.premium-header{
  display:flex;
  flex-direction:column;
  gap:14px;
}
@media (min-width:768px){
  .premium-header{
    flex-direction:row;
    align-items:center;
    justify-content:space-between;
  }
}

.glass-card{
  background:rgba(255,255,255,.75);
  backdrop-filter:blur(18px);
  border:1px solid rgba(0,0,0,.06);
  border-radius:1.4rem;
  box-shadow:0 20px 45px rgba(0,0,0,.08);
}

.site-switcher{
  width:100%;
  background:linear-gradient(180deg,#ffffff,#f8fafc);
  border:1px solid #e2e8f0;
  border-radius:12px;
  padding:.45rem .6rem;
  font-size:1.05rem;
  font-weight:800;
}

.date-input-modern{
  border:1px solid #e2e8f0;
  border-radius:12px;
  padding:.5rem .7rem;
  font-weight:700;
  background:white;
  box-shadow:0 4px 10px rgba(0,0,0,.05);
}

.live-bar{
  backdrop-filter:blur(20px);
  background:linear-gradient(135deg,#ffffff,#fffdf5);
  border:1px solid #fde68a;
  border-radius:1.4rem;
  padding:14px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 18px 40px rgba(0,0,0,.10);
}

.chip-btn{
  font-size:.75rem;
  font-weight:800;
  padding:.35rem .7rem;
  border-radius:.6rem;
  background:#eef2ff;
  color:#3730a3;
}

.save-btn{
  background:linear-gradient(135deg,var(--accent),var(--accent-strong));
  color:#422006;
  font-weight:900;
  padding:1.15rem;
  border-radius:1.4rem;
  box-shadow:0 18px 45px rgba(245,158,11,.35);
  transition:.25s;
}
.save-btn:hover{ transform:translateY(-3px); }
/* ===== RESET BUTTON ===== */
.reset-btn-modern{
  background:linear-gradient(135deg,#ef4444,#dc2626);
  color:white;
  font-size:.85rem;
  font-weight:800;
  padding:.45rem .9rem;
  border-radius:.6rem;
  box-shadow:0 6px 16px rgba(220,38,38,.35);
  transition:all .2s ease;
  display:inline-flex;
  align-items:center;
  gap:4px;
}

.reset-btn-modern:hover{
  background:linear-gradient(135deg,#dc2626,#b91c1c);
  transform:translateY(-1px);
  box-shadow:0 10px 22px rgba(220,38,38,.45);
}

.reset-btn-modern:active{
  transform:translateY(0);
  box-shadow:0 4px 10px rgba(220,38,38,.35);
}
.reset-link{
  display:block;
  padding:.55rem .8rem;
  font-size:.85rem;
  font-weight:600;
}
.reset-link:hover{ background:#f8fafc; }

@media (max-width:640px){
  .save-btn{ position:sticky; bottom:12px; }
}
/* ===== MODAL BASE CARD ===== */
.modal-card{
  background:#ffffff;
  border-radius:16px;
  box-shadow:0 30px 80px rgba(0,0,0,.25);
  overflow:hidden;
  width:100%;
  animation:modalIn .18s ease;
}

/* entry animation */
@keyframes modalIn{
  from{
    transform:scale(.96);
    opacity:0;
  }
  to{
    transform:scale(1);
    opacity:1;
  }
}

/* ===== MODAL HEADER ===== */
.modal-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 18px;
  border-bottom:1px solid #e5e7eb;
  font-weight:800;
  font-size:1rem;
  color:#0f172a;
  background:#fafafa;
}

/* ===== CLOSE BUTTON ===== */
.modal-close{
  font-size:1.1rem;
  font-weight:900;
  color:#64748b;
  padding:4px 8px;
  border-radius:6px;
  transition:.15s ease;
  line-height:1;
}

.modal-close:hover{
  background:#f1f5f9;
  color:#0f172a;
  transform:scale(1.05);
}

/* ===== TEXTAREA ===== */
.modal-textarea{
  width:100%;
  border:1px solid #e2e8f0;
  border-radius:10px;
  padding:.65rem .75rem;
  font-size:.9rem;
  font-weight:600;
  resize:vertical;
  min-height:110px;
  background:#ffffff;
  transition:.15s ease;
}

.modal-textarea:focus{
  outline:none;
  border-color:#facc15;
  box-shadow:0 0 0 2px rgba(250,204,21,.18);
}

/* ===== FOOTER ===== */
.modal-footer{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  padding:12px 16px;
  border-top:1px solid #e5e7eb;
  background:#fafafa;
}

/* ===== BUTTON BASE ===== */
.modal-btn{
  font-size:.85rem;
  font-weight:800;
  padding:.45rem .95rem;
  border-radius:.6rem;
  transition:.18s ease;
}

/* cancel button */
.modal-btn.cancel{
  background:#f1f5f9;
  color:#334155;
}

.modal-btn.cancel:hover{
  background:#e2e8f0;
}

/* save button */
.modal-btn.save{
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:white;
  box-shadow:0 6px 16px rgba(34,197,94,.35);
}

.modal-btn.save:hover{
  background:linear-gradient(135deg,#16a34a,#15803d);
  transform:translateY(-1px);
  box-shadow:0 10px 22px rgba(34,197,94,.45);
}

.modal-btn.save:active{
  transform:translateY(0);
}
</style>

<!-- ================= JS ================= -->

<script>

function money(n){
  return "‚Çπ" + Number(n || 0).toLocaleString("en-IN");
}

/* ================= CIVIL ================= */
function calcCivil(id, masonRate, helperRate) {

  const mf = +document.querySelector(`[name="mason_full_${id}"]`)?.value || 0;
  const hf = +document.querySelector(`[name="helper_full_${id}"]`)?.value || 0;
  const mh = +document.querySelector(`[name="mason_half_${id}"]`)?.value || 0;
  const hh = +document.querySelector(`[name="helper_half_${id}"]`)?.value || 0;
  const advance = +document.querySelector(`[name="advance_${id}"]`)?.value || 0;

  const labour =
    (mf * masonRate) +
    (mh * masonRate / 2) +
    (hf * helperRate) +
    (hh * helperRate / 2);

  const total = Math.max(labour - advance);

  document.getElementById(`civil_labour_${id}`).innerText =
    labour.toLocaleString("en-IN");

  document.getElementById(`civil_total_${id}`).innerText =
    total.toLocaleString("en-IN");

  updateLiveGrandTotal();
}

/* ================= DEPT ================= */
function calcDept(id) {
  let full = +document.querySelector(`[name="dept_full_${id}"]`)?.value || 0;
  let half = +document.querySelector(`[name="dept_half_${id}"]`)?.value || 0;
  let advance = +document.querySelector(`[name="dept_advance_${id}"]`)?.value || 0;
  let rate = +document.querySelector(`[name="dept_rate_${id}"]`)?.value || 0;

  let labour = (full * rate) + (half * rate / 2);
  let total = Math.max(labour - advance, 0);

  document.getElementById(`dept_labour_${id}`).innerText =
    labour.toLocaleString("en-IN");

  document.getElementById(`dept_total_${id}`).innerText =
    total.toLocaleString("en-IN");

  updateLiveGrandTotal();
}

/* ================= LIVE GRAND ================= */

function updateLiveGrandTotal(){
  let total = 0;

  // ===== CIVIL =====
  document.querySelectorAll('[id^="civil_total_"]').forEach(el=>{
    total += Number((el.innerText || "0").replace(/,/g,'')) || 0;
  });

  // ===== DEPT =====
  document.querySelectorAll('[id^="dept_total_"]').forEach(el=>{
    total += Number((el.innerText || "0").replace(/,/g,'')) || 0;
  });

  // ===== MATERIAL =====
  document.querySelectorAll('[id^="material_total_"]').forEach(el=>{
    total += Number(el.value || 0);
  });

  // ‚úÖ ‚úÖ EXPENSE (VERY IMPORTANT)
  document.querySelectorAll('[name^="expense_amount_"]').forEach(el=>{
    total += Number(el.value || 0);
  });

  // ===== UPDATE UI =====
  const grand = document.getElementById("liveGrandTotal");
  if (grand){
    grand.innerText = "‚Çπ" + total.toLocaleString("en-IN");
  }
}

/* auto triggers */
document.addEventListener("input", updateLiveGrandTotal);
document.addEventListener("DOMContentLoaded", updateLiveGrandTotal);


/* ================= RESET MENU ================= */
function toggleResetMenu(id) {
  const menu = document.getElementById("resetMenu" + id);
  document.querySelectorAll("[id^='resetMenu']").forEach(m => {
    if (m !== menu) m.classList.add("hidden");
  });
  menu.classList.toggle("hidden");
}

/* ================= NAV ================= */
function goToEdit(siteId) {
  const date = document.getElementById("work_date").value;
  if (!date) return alert("Please select a date");
  window.location.href = `/site/${siteId}/?date=${encodeURIComponent(date)}`;
}

function switchSite() {
  const siteId = document.getElementById("siteSwitcher").value;
  const date = document.getElementById("work_date")?.value;
  let url = `/site/${siteId}/`;
  if (date) url += `?date=${date}`;
  window.location.href = url;
}

/* ================= SMART COPY ================= */

let currentSiteId = null;

function openCopyModal(siteId){
  currentSiteId = siteId;

  const modal = document.getElementById("copyModal");
  if (!modal) return;

  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

/* ================= SMART COPY SELECTED ================= */
function runSmartCopy() {
  const date = document.getElementById("work_date")?.value;
  if (!date) return alert("‚ö†Ô∏è Select date first");

  const params = new URLSearchParams({
    date: date,
    civil: document.getElementById("copyCivil")?.checked ? 1 : 0,
    dept: document.getElementById("copyDept")?.checked ? 1 : 0,
    material: document.getElementById("copyMaterial")?.checked ? 1 : 0,
    desc: document.getElementById("copyDesc")?.checked ? 1 : 0,
    replace: document.getElementById("copyReplace")?.checked ? 1 : 0,
  });

  window.location.href =
    `/site/${currentSiteId}/copy-previous/?${params.toString()}`;
}


function openDescModal(){
  const modal = document.getElementById("descModal");
  if (!modal) return;

  // show modal
  modal.classList.remove("hidden");
  modal.classList.add("flex");

  // load existing text
  const hiddenVal = document.getElementById("daily_description_input")?.value || "";
  const textarea = document.getElementById("daily_description_text");
  if (textarea) textarea.value = hiddenVal;
}
function closeDescModal(){
  const modal = document.getElementById("descModal");
  if (!modal) return;

  modal.classList.add("hidden");
  modal.classList.remove("flex");
}
function saveDescription(){
  const textarea = document.getElementById("daily_description_text");
  const hiddenInput = document.getElementById("daily_description_input");
  const preview = document.getElementById("descPreviewText");

  if (!textarea || !hiddenInput) {
    console.error("Description elements missing");
    return;
  }

  const text = textarea.value.trim();

  // ‚úÖ update hidden input (THIS IS WHAT DJANGO SAVES)
  hiddenInput.value = text;

  // ‚úÖ update preview UI
  if (preview){
    preview.innerText = text || "No description added for this day.";
  }

  // ‚úÖ close modal
  closeDescModal();
}
function closeCopyModal(){
  const modal = document.getElementById("copyModal");
  if (!modal) return;

  modal.classList.add("hidden");
  modal.classList.remove("flex");
}
document.addEventListener("click", function(e){
  const modal = document.getElementById("copyModal");
  if (!modal) return;

  if (e.target === modal){
    closeCopyModal();
  }
});
</script>

{% endblock %}
