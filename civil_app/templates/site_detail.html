{% extends "base.html" %}
{% load civil_extras %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 py-6 space-y-8 animate-page">

  <!-- ================= HEADER ================= -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
<h2 class="text-2xl font-extrabold text-slate-900 flex items-center gap-2 flex-wrap">
  üèó

  <!-- FIXED WIDTH WRAPPER -->
  <div class="min-w-[220px]">

    <select id="siteSwitcher"
            onchange="switchSite()"
            class="w-full bg-white text-slate-900 border border-slate-300
                   rounded-lg px-3 py-1.5 text-lg font-bold
                   shadow-sm focus:outline-none focus:ring-2 focus:ring-yellow-400">

      {% for s in sites %}
        <option value="{{ s.id }}"
          {% if s.id == site.id %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}

    </select>
  </div>

  <span>‚Äì Daily Entry</span>
</h2>
      <p class="text-sm text-gray-500">
        Enter labour, advances and materials
      </p>
    </div>
    <div class="flex items-center gap-3">
      <input type="date"
             id="work_date"
             value="{{ work_date|date:'Y-m-d' }}"
             onchange="goToEdit({{ site.id }})"
             class="date-input">

      <!-- RESET -->
      <div class="relative">
        <button onclick="toggleResetMenu({{ site.id }})"
                class="reset-btn">
          Reset ‚ñæ
        </button>
        
<button type="button"
        onclick="openCopyModal()"
        class="btn-green-modern">
  üìã Smart Copy
</button>
        <div id="resetMenu{{ site.id }}"
             class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border z-50">
          <a href="{% url 'reset_site_today' site.id %}"
             onclick="return confirm('Reset today entries?')"
             class="reset-link">üîÑ Reset Today</a>

          <a href="{% url 'reset_site_month' site.id %}"
             onclick="return confirm('Reset this month entries?')"
             class="reset-link">üìÖ Reset Month</a>

          <a href="#"
             onclick="resetByDate({{ site.id }})"
             class="reset-link text-orange-600">
            üìÜ Reset Selected Date
          </a>

          <div class="border-t"></div>

          <a href="{% url 'reset_site_all' site.id %}"
             onclick="return confirm('Delete ALL entries?')"
             class="reset-link text-red-600 font-semibold">
            üóë Reset All
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= DAILY DESCRIPTION PREVIEW ================= -->
<div id="descPreviewCard"
     class="bg-white/80 backdrop-blur border border-slate-200 rounded-2xl shadow-sm p-4">

  <div class="flex items-start justify-between gap-3">
    <div>
      <p class="text-xs font-bold text-indigo-600 tracking-wide">
        üìù DAILY NOTE
      </p>

      <p id="descPreviewText"
         class="text-sm text-slate-700 font-medium mt-1 whitespace-pre-line">
        {{ daily_description|default_if_none:""|default:"No description added for this day." }}

      </p>
    </div>

    <button type="button"
            onclick="openDescModal()"
            class="text-xs font-bold px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-700 hover:bg-indigo-100">
      Edit
    </button>
  </div>
</div>

<form method="post">
{% csrf_token %}
<input type="hidden" name="date" value="{{ work_date|date:'Y-m-d' }}">
<input type="hidden" name="daily_description" id="daily_description_input"
       value="{{ daily_description|default:'' }}">

<!-- ================= CIVIL ================= -->
<h3 class="section-title text-blue-700">üë∑ Civil Teams</h3>

<div class="card">

  <div class="grid grid-cols-10 header-row">
    <div class="text-center">Team</div><div class="text-center">M F</div><div class="text-center">H F</div><div class="text-center">M H</div><div class="text-center">H H</div>
    <div class="text-center">Mason ‚Çπ</div><div class="text-center">Helper ‚Çπ</div><div class="text-center">Advance</div><div class="text-center">Labour</div><div class="text-center">Total</div>
  </div>

  {% for row in civil_rows %}
  <div class="grid grid-cols-10 data-row">
    <div class="font-semibold">{{ row.team.name }}</div>

    <input name="mason_full_{{ row.team.id }}" value="{{ row.work.mason_full|default:0 }}"
           class="input-box"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input name="helper_full_{{ row.team.id }}" value="{{ row.work.helper_full|default:0 }}"
           class="input-box"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input name="mason_half_{{ row.team.id }}" value="{{ row.work.mason_half|default:0 }}"
           class="input-box"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input name="helper_half_{{ row.team.id }}" value="{{ row.work.helper_half|default:0 }}"
           class="input-box"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <div class="rate-box">‚Çπ{{ row.rate.mason_full_rate }}</div>
    <div class="rate-box">‚Çπ{{ row.rate.helper_full_rate }}</div>

    <input name="advance_{{ row.team.id }}" value="{{ row.advance }}"
           class="advance-box"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <div id="civil_labour_{{ row.team.id }}" class="labour-box">{{ row.labour }}</div>
    <div id="civil_total_{{ row.team.id }}" class="total-box">{{ row.total }}</div>
  </div>
  {% endfor %}
</div>

<!-- ================= DEPARTMENTS ================= -->
<h3 class="section-title text-orange-600">üè¢ Other Departments</h3>

<div class="card">

  <div class="grid grid-cols-7 header-row">
    <div class="text-center">Department</div><div class="text-center">Full</div><div class="text-center">Half</div>
    <div class="text-center">Rate</div><div class="text-center">Advance</div><div class="text-center">Labour</div><div class="text-center">Total</div>
  </div>

  {% for dept in other_depts %}
  {% with row=dept_map|get_item:dept.id %}
  <div class="grid grid-cols-7 data-row">
    <div class="font-semibold">{{ dept.name }}</div>

    <input name="dept_full_{{ dept.id }}" value="{{ row.full_day_count|default:0 }}"
           class="input-box"
           oninput="calcDept({{ dept.id }}, {{ default_rates|get_item:dept.id|default:0 }})">

    <input name="dept_half_{{ dept.id }}" value="{{ row.half_day_count|default:0 }}"
           class="input-box"
           oninput="calcDept({{ dept.id }}, {{ default_rates|get_item:dept.id|default:0 }})">

    <input name="dept_rate_{{ dept.id }}"
       value="{% if row and row.full_day_rate %}{{ row.full_day_rate }}{% else %}{{ default_rates|get_item:dept.id|default:0 }}{% endif %}"
       class="input-box"
       oninput="calcDept({{ dept.id }})">


    <input name="dept_advance_{{ dept.id }}" value="{{ row.advance_amount|default:0 }}"
           class="advance-box"
           oninput="calcDept({{ dept.id }}, {{ default_rates|get_item:dept.id|default:0 }})">

    <div id="dept_labour_{{ dept.id }}" class="labour-box">{{ row.labour_amount|default:0 }}</div>
    <div id="dept_total_{{ dept.id }}" class="total-box">{{ row.total_amount|default:0 }}</div>
  </div>
  {% endwith %}
  {% endfor %}
</div>

<!-- ================= MATERIALS ================= -->
<h3 class="section-title text-green-700">üß± Materials</h3>

<div class="card p-0 overflow-hidden">

  <!-- Sticky Header -->
  <div class="bg-slate-50 border-b sticky top-0 z-10">
    <div class="grid grid-cols-8 header-row px-4 py-3">
      <div class="text-center">Agent</div>
      <div class="text-center">Material</div>
      <div class="text-center">Qty</div>
      <div class="text-center">Unit</div>
      <div class="text-center">Rate</div>
      <div class="text-center text-orange-600">Advance</div>
      <div class="text-center text-green-700">Total</div>
      <div class="text-center">Action</div>
    </div>
  </div>

  <!-- Scroll Area -->
  <div id="materialRows" class="max-h-[320px] overflow-y-auto px-4 py-3 space-y-2">

    {% for m in materials %}
    <div class="grid grid-cols-8 gap-2 items-center material-row">
      <input name="agent_name_{{ forloop.counter0 }}" value="{{ m.agent_name }}" class="input-box">
      <input name="material_name_{{ forloop.counter0 }}" value="{{ m.name }}" class="input-box">
      <input name="material_qty_{{ forloop.counter0 }}" value="{{ m.quantity }}" class="input-box" oninput="calcMaterial({{ forloop.counter0 }})">
      <input name="material_unit_{{ forloop.counter0 }}" value="{{ m.unit }}" class="input-box">
      <input name="material_rate_{{ forloop.counter0 }}" value="{{ m.rate }}" class="input-box" oninput="calcMaterial({{ forloop.counter0 }})">

      <input name="material_advance_{{ forloop.counter0 }}"
             value="{{ m.advance|default:0 }}"
             class="advance-box"
             oninput="calcMaterial({{ forloop.counter0 }})">

      <input id="material_total_{{ forloop.counter0 }}"
             value="{{ m.total }}"
             class="input-box bg-green-100 font-extrabold text-green-800"
             readonly>

      <button type="button"
              onclick="this.closest('.material-row').remove()"
              class="delete-btn-modern">
        ‚úï
      </button>
    </div>
    
    {% endfor %}

  </div>

  <!-- Footer -->
  <div class="border-t bg-slate-50 px-4 py-3 flex justify-between items-center">
    <div class="text-xs text-gray-500">
      üí° Tip: Advance will reduce material total
    </div>

    <button type="button" onclick="addMaterialRow()" class="btn-green-modern">
      ‚ûï Add Material
    </button>
  </div>

</div>


<!-- ================= SAVE ================= -->
<button type="submit" class="save-btn w-full">
  {% if request.GET.date %} üîÑ Update Entries {% else %} ‚úÖ Save Entries {% endif %}
</button>

</form>
</div>
<!-- ================= DESCRIPTION MODAL ================= -->
<div id="descModal"
     class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 backdrop-blur-sm">

  <div class="bg-white w-[95%] max-w-lg rounded-2xl shadow-2xl p-6 animate-modal">

    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-extrabold text-slate-800">
        üìù Daily Description
      </h3>

      <button onclick="closeDescModal()"
              class="text-gray-400 hover:text-red-500 text-xl font-bold">
        ‚úï
      </button>
    </div>

    <textarea id="daily_description_text"
              class="w-full border rounded-xl p-3 h-32 focus:outline-none focus:ring-2 focus:ring-amber-400"
              placeholder="Enter today's work summary...">{{ daily_description }}</textarea>

    <div class="flex justify-end gap-3 mt-5">
      <button type="button"
              onclick="closeDescModal()"
              class="px-4 py-2 rounded-lg bg-gray-100 font-semibold">
        Cancel
      </button>

      <button type="button"
              onclick="saveDescription()"
              class="px-5 py-2 rounded-lg bg-amber-500 hover:bg-amber-600 text-white font-bold shadow">
        Save
      </button>
    </div>

  </div>
</div>


<!-- ================= COPY MODAL ================= -->
<div id="copyModal"
     class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">

  <div class="bg-white rounded-2xl shadow-2xl w-[360px] p-6 animate-page">

    <h3 class="text-lg font-extrabold mb-4 text-slate-800">
      üìã Copy Previous Day
    </h3>

    <div class="space-y-2 text-sm font-semibold">

      <label class="flex items-center gap-2">
        <input type="checkbox" id="copyCivil" checked>
        üë∑ Civil
      </label>

      <label class="flex items-center gap-2">
        <input type="checkbox" id="copyDept" checked>
        üè¢ Departments
      </label>

      <label class="flex items-center gap-2">
        <input type="checkbox" id="copyMaterial" checked>
        üß± Materials
      </label>

      <label class="flex items-center gap-2">
        <input type="checkbox" id="copyDesc" checked>
        üìù Description
      </label>

      <label class="flex items-center gap-2 mt-3 border-t pt-3">
        <input type="checkbox" id="copyReplace">
        ‚ö†Ô∏è Replace existing data
      </label>

    </div>

    <div class="flex justify-end gap-3 mt-6">
      <button onclick="closeCopyModal()"
              class="px-4 py-2 rounded-lg bg-gray-200 font-bold">
        Cancel
      </button>

      <button onclick="runSmartCopy({{ site.id }})"
              class="btn-green-modern">
        üöÄ Copy Now
      </button>
    </div>

  </div>
</div>
<!-- ================= STYLES ================= -->
<style>
:root{
  --lemon:#facc15;
  --lemon-soft:#fff7cc;
}

.animate-page{animation:fadeUp .35s ease-out}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1}}

.section-title{
  font-size:1.18rem;
  font-weight:900;
  letter-spacing:.3px;
  margin-top:1em;
}

.card{
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(0,0,0,0.06);
  border-radius: 1.25rem;
  box-shadow: 0 10px 30px rgba(0,0,0,0.06);
  overflow: hidden;
}

.header-row{background:#f8fafc;font-size:.75rem;font-weight:700;padding:.6rem}
.data-row{padding:.5rem;transition:.2s}
.data-row:hover{
  background:#fffdf5;
  transform: scale(1.002);
}


.input-box{
  border:1px solid #e5e7eb;
  border-radius:.6rem;
  padding:.42rem;
  text-align:center;
  background:#ffffff;
  transition: all .15s ease;
  font-weight:600;
}

.input-box:focus{
  outline:none;
  border-color:#facc15;
  box-shadow:0 0 0 3px rgba(250,204,21,.25);
  transform: scale(1.02);
}



.rate-box{background:#f1f5f9;border-radius:.5rem;font-weight:700;text-align:center;padding:.35rem}
.advance-box{
  background:#fff7cc;
  border:1px solid #facc15;
  font-weight:800;
  border-radius:.6rem;
  text-align:center;
  padding:.4rem;
}

.labour-box{
  background:linear-gradient(180deg,#fef3c7,#fde68a);
  font-weight:800;
  text-align:center;
  border-radius:.6rem;
  padding:.4rem;
}

.total-box{
  background:linear-gradient(180deg,#dcfce7,#bbf7d0);
  font-weight:900;
  text-align:center;
  border-radius:.6rem;
  padding:.4rem;
}

.save-btn{
  background: linear-gradient(135deg,#facc15,#f59e0b);
  color:#422006;
  font-weight:900;
  padding:1.1rem;
  border-radius:1.3rem;
  transition:.25s;
  box-shadow:0 10px 25px rgba(245,158,11,.35);
  letter-spacing:.3px;
}

.save-btn:hover{
  transform: translateY(-3px) scale(1.01);
  box-shadow:0 18px 40px rgba(245,158,11,.45);
}


.reset-btn{background:#fee2e2;color:#b91c1c;padding:.5rem 1rem;border-radius:.75rem;font-weight:700}
.reset-link{display:block;padding:.5rem .75rem;font-size:.85rem}
.reset-link:hover{background:#f1f5f9}

.date-input{border:1px solid #d1d5db;border-radius:.75rem;padding:.5rem}
.delete-btn{background:#fee2e2;color:#b91c1c;border-radius:.5rem;padding:.25rem;font-size:.8rem;font-weight:700}
.btn-green{background:#16a34a;color:white;padding:.5rem 1rem;border-radius:.75rem;font-weight:700}


/* Material row hover */
.material-row{
  padding: 4px;
  border-radius: 10px;
  transition: all .15s ease;
}
.material-row:hover{
  background:#f8fafc;
  transform:scale(1.01);
}

/* Modern delete button */
.delete-btn-modern{
  background:#fee2e2;
  color:#b91c1c;
  border-radius:10px;
  font-weight:800;
  padding:6px 10px;
  transition:.2s;
}
.delete-btn-modern:hover{
  background:#fecaca;
  transform:scale(1.05);
}

/* Modern add button */
.btn-green-modern{
  background:linear-gradient(135deg,#16a34a,#22c55e);
  color:white;
  padding:.55rem 1.2rem;
  border-radius:.75rem;
  font-weight:800;
  box-shadow:0 6px 14px rgba(0,0,0,.15);
  transition:.25s;
}
.btn-green-modern:hover{
  transform:translateY(-2px);
  box-shadow:0 12px 22px rgba(0,0,0,.25);
}

</style>
<!-- ================= JS ================= -->
<script>

function calcCivil(id, masonRate, helperRate) {

  const mf = +document.querySelector(`[name="mason_full_${id}"]`)?.value || 0;
  const hf = +document.querySelector(`[name="helper_full_${id}"]`)?.value || 0;
  const mh = +document.querySelector(`[name="mason_half_${id}"]`)?.value || 0;
  const hh = +document.querySelector(`[name="helper_half_${id}"]`)?.value || 0;
  
  const advance = +document.querySelector(`[name="advance_${id}"]`)?.value || 0;

  const labour =
    (mf * masonRate) +
    (mh * masonRate / 2) +
    (hf * helperRate) +
    (hh * helperRate / 2);

  
  const total = labour - advance;
  document.getElementById(`civil_labour_${id}`).innerText = labour;
  document.getElementById(`civil_total_${id}`).innerText = total;
}

function calcDept(id) {
  let full = +document.querySelector(`[name="dept_full_${id}"]`)?.value || 0;
  let half = +document.querySelector(`[name="dept_half_${id}"]`)?.value || 0;
  let advance = +document.querySelector(`[name="dept_advance_${id}"]`)?.value || 0;
  let rate = +document.querySelector(`[name="dept_rate_${id}"]`)?.value || 0;

  let labour = (full * rate) + (half * rate / 2);
  let total = labour - advance;

  document.getElementById(`dept_labour_${id}`).innerText = labour;
  document.getElementById(`dept_total_${id}`).innerText = total;
}


function toggleResetMenu(id) {
  const menu = document.getElementById("resetMenu" + id);

  // Close all menus first
  document.querySelectorAll("[id^='resetMenu']").forEach(m => {
    if (m !== menu) m.classList.add("hidden");
  });

  // Toggle selected menu
  menu.classList.toggle("hidden");
}

// Close menu when clicking outside
document.addEventListener("click", function (e) {
  const isButton = e.target.closest("[onclick^='toggleResetMenu']");
  const isMenu = e.target.closest("[id^='resetMenu']");

  if (!isButton && !isMenu) {
    document.querySelectorAll("[id^='resetMenu']").forEach(m =>
      m.classList.add("hidden")
    );
  }
});
function resetByDate(siteId) {
  const date = document.getElementById("work_date").value;

  if (!date) {
    alert("Please select a date first");
    return;
  }

  if (!confirm("Reset entries for selected date?")) return;

  window.location.href = `/site/${siteId}/reset/date/?date=${date}`;
}


function goToEdit(siteId) {
  const dateInput = document.getElementById("work_date");

  if (!dateInput || !dateInput.value) {
    alert("Please select a date");
    return;
  }

  const date = dateInput.value;

  // Force navigation
  window.location.href = `/site/${siteId}/?date=${encodeURIComponent(date)}`;
}



let materialIndex = {{ materials|length }};

function addMaterialRow() {
  const container = document.getElementById("materialRows");

  const row = document.createElement("div");
  row.className = "grid grid-cols-8 gap-2 items-center mb-2 material-row";


  row.innerHTML = `
  <input name="agent_name_${materialIndex}" class="input-box">
  <input name="material_name_${materialIndex}" class="input-box">
  <input name="material_qty_${materialIndex}" class="input-box" oninput="calcMaterial(${materialIndex})">
  <input name="material_unit_${materialIndex}" class="input-box">
  <input name="material_rate_${materialIndex}" class="input-box" oninput="calcMaterial(${materialIndex})">

  <input name="material_advance_${materialIndex}" value="0"
         class="advance-box"
         oninput="calcMaterial(${materialIndex})">

  <input id="material_total_${materialIndex}" class="input-box bg-green-100 font-bold" readonly>

  <button type="button" onclick="this.parentElement.remove()" class="text-red-600 bg-red-100 rounded py-1 font-bold">Delete</button>
`;


  container.appendChild(row);
  materialIndex++;
}

function calcMaterial(index) {
  const qty = Number(document.querySelector(`[name="material_qty_${index}"]`)?.value || 0);
  const rate = Number(document.querySelector(`[name="material_rate_${index}"]`)?.value || 0);
  const advance = Number(document.querySelector(`[name="material_advance_${index}"]`)?.value || 0);

  const total = (qty * rate) - advance;

  document.getElementById(`material_total_${index}`).value = total;
}

function openDescModal(){
  const hiddenVal = document.getElementById("daily_description_input").value;
  document.getElementById("daily_description_text").value = hiddenVal;

  document.getElementById("descModal").classList.remove("hidden");
  document.getElementById("descModal").classList.add("flex");
}

function closeDescModal(){
  document.getElementById("descModal").classList.add("hidden");
  document.getElementById("descModal").classList.remove("flex");
}

function saveDescription(){
  const text = document.getElementById("daily_description_text").value.trim();

  document.getElementById("daily_description_input").value = text;

  const preview = document.getElementById("descPreviewText");
  preview.innerText = text || "No description added for this day.";

  closeDescModal();
}


function openCopyModal() {
  document.getElementById("copyModal").classList.remove("hidden");
  document.getElementById("copyModal").classList.add("flex");
}

function closeCopyModal() {
  document.getElementById("copyModal").classList.add("hidden");
}

function runSmartCopy(siteId) {
  const date = document.getElementById("work_date").value;

  if (!date) {
    alert("Select date first");
    return;
  }

  let url = `/site/${siteId}/copy-previous/?date=${date}`;

  if (document.getElementById("copyCivil").checked) url += "&civil=1";
  if (document.getElementById("copyDept").checked) url += "&dept=1";
  if (document.getElementById("copyMaterial").checked) url += "&material=1";
  if (document.getElementById("copyDesc").checked) url += "&desc=1";
  if (document.getElementById("copyReplace").checked) url += "&replace=1";

  window.location.href = url;
}


function confirmCopy() {
  if (confirm("Replace today's data if exists?")) {
    // user wants replace
    const url = new URL(event.target.href);
    url.searchParams.set("replace", "1");
    event.target.href = url.toString();
  }
  return true;
}


function switchSite() {
  const siteId = document.getElementById("siteSwitcher").value;
  const date = document.getElementById("work_date")?.value;

  let url = `/site/${siteId}/`;

  if (date) {
    url += `?date=${date}`;
  }

  window.location.href = url;
}

</script>

{% endblock %}
