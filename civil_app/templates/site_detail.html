{% extends "base.html" %}
{% load civil_extras %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 py-6 space-y-8 animate-page">

  <!-- ================= HEADER ================= -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h2 class="text-2xl font-extrabold text-slate-900">
        üèó {{ site.name }} ‚Äì Daily Entry
      </h2>
      <p class="text-sm text-gray-500">
        Enter labour, advances and materials
      </p>
    </div>

    <div class="flex items-center gap-3">
      <input type="date"
             id="work_date"
             value="{{ today|date:'Y-m-d' }}"
             onchange="goToEdit({{ site.id }})"
             class="date-input">

      <!-- RESET -->
      <div class="relative">
        <button onclick="toggleResetMenu({{ site.id }})"
                class="reset-btn">
          Reset ‚ñæ
        </button>

        <div id="resetMenu{{ site.id }}"
             class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border z-50">
          <a href="{% url 'reset_site_today' site.id %}"
             onclick="return confirm('Reset today entries?')"
             class="reset-link">üîÑ Reset Today</a>

          <a href="{% url 'reset_site_month' site.id %}"
             onclick="return confirm('Reset this month entries?')"
             class="reset-link">üìÖ Reset Month</a>

          <a href="#"
             onclick="resetByDate({{ site.id }})"
             class="reset-link text-orange-600">
            üìÜ Reset Selected Date
          </a>

          <div class="border-t"></div>

          <a href="{% url 'reset_site_all' site.id %}"
             onclick="return confirm('Delete ALL entries?')"
             class="reset-link text-red-600 font-semibold">
            üóë Reset All
          </a>
        </div>
      </div>
    </div>
  </div>

<form method="post">
{% csrf_token %}
<input type="hidden" name="date" value="{{ today }}">

<!-- ================= CIVIL ================= -->
<h3 class="section-title text-blue-700">üë∑ Civil Teams</h3>

<div class="card">

  <div class="grid grid-cols-10 header-row">
    <div>Team</div><div>M F</div><div>H F</div><div>M H</div><div>H H</div>
    <div>Mason ‚Çπ</div><div>Helper ‚Çπ</div><div>Advance</div><div>Labour</div><div>Total</div>
  </div>

  {% for row in civil_rows %}
  <div class="grid grid-cols-10 data-row">
    <div class="font-semibold">{{ row.team.name }}</div>

    <input name="mason_full_{{ row.team.id }}" value="{{ row.work.mason_full|default:0 }}"
           class="input-box"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input name="helper_full_{{ row.team.id }}" value="{{ row.work.helper_full|default:0 }}"
           class="input-box"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input name="mason_half_{{ row.team.id }}" value="{{ row.work.mason_half|default:0 }}"
           class="input-box"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input name="helper_half_{{ row.team.id }}" value="{{ row.work.helper_half|default:0 }}"
           class="input-box"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <div class="rate-box">‚Çπ{{ row.rate.mason_full_rate }}</div>
    <div class="rate-box">‚Çπ{{ row.rate.helper_full_rate }}</div>

    <input name="advance_{{ row.team.id }}" value="{{ row.advance }}"
           class="advance-box"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <div id="civil_labour_{{ row.team.id }}" class="labour-box">{{ row.labour }}</div>
    <div id="civil_total_{{ row.team.id }}" class="total-box">{{ row.total }}</div>
  </div>
  {% endfor %}
</div>

<!-- ================= DEPARTMENTS ================= -->
<h3 class="section-title text-orange-600">üè¢ Other Departments</h3>

<div class="card">

  <div class="grid grid-cols-7 header-row">
    <div>Department</div><div>Full</div><div>Half</div>
    <div>Rate</div><div>Advance</div><div>Labour</div><div>Total</div>
  </div>

  {% for dept in other_depts %}
  {% with row=dept_map|get_item:dept.id %}
  <div class="grid grid-cols-7 data-row">
    <div class="font-semibold">{{ dept.name }}</div>

    <input name="dept_full_{{ dept.id }}" value="{{ row.full_day_count|default:0 }}"
           class="input-box"
           oninput="calcDept({{ dept.id }}, {{ default_rates|get_item:dept.id|default:0 }})">

    <input name="dept_half_{{ dept.id }}" value="{{ row.half_day_count|default:0 }}"
           class="input-box"
           oninput="calcDept({{ dept.id }}, {{ default_rates|get_item:dept.id|default:0 }})">

    <div class="rate-box">‚Çπ{{ default_rates|get_item:dept.id }}</div>

    <input name="dept_advance_{{ dept.id }}" value="{{ row.advance_amount|default:0 }}"
           class="advance-box"
           oninput="calcDept({{ dept.id }}, {{ default_rates|get_item:dept.id|default:0 }})">

    <div id="dept_labour_{{ dept.id }}" class="labour-box">{{ row.labour_amount|default:0 }}</div>
    <div id="dept_total_{{ dept.id }}" class="total-box">{{ row.total_amount|default:0 }}</div>
  </div>
  {% endwith %}
  {% endfor %}
</div>

<!-- ================= MATERIALS ================= -->
<h3 class="section-title text-green-700">üß± Materials</h3>

<div class="card p-4">

  <div class="grid grid-cols-7 header-row mb-2">
    <div>Agent</div><div>Material</div><div>Qty</div>
    <div>Unit</div><div>Rate</div><div>Total</div><div>Action</div>
  </div>

  <div id="materialRows">
    {% for m in materials %}
    <div class="grid grid-cols-7 gap-2 mb-2">
      <input name="agent_name_{{ forloop.counter0 }}" value="{{ m.agent_name }}" class="input-box">
      <input name="material_name_{{ forloop.counter0 }}" value="{{ m.name }}" class="input-box">
      <input name="material_qty_{{ forloop.counter0 }}" value="{{ m.quantity }}" class="input-box" oninput="calcMaterial({{ forloop.counter0 }})">
      <input name="material_unit_{{ forloop.counter0 }}" value="{{ m.unit }}" class="input-box">
      <input name="material_rate_{{ forloop.counter0 }}" value="{{ m.rate }}" class="input-box" oninput="calcMaterial({{ forloop.counter0 }})">
      <input id="material_total_{{ forloop.counter0 }}" value="{{ m.total }}" class="input-box bg-green-100 font-bold" readonly>
      <button type="button" onclick="this.parentElement.remove()" class="delete-btn">Delete</button>
    </div>
    {% endfor %}
  </div>

  <button type="button" onclick="addMaterialRow()" class="btn-green mt-3">
    ‚ûï Add Material
  </button>
</div>

<!-- ================= SAVE ================= -->
<button type="submit" class="save-btn w-full">
  {% if request.GET.date %} üîÑ Update Entries {% else %} ‚úÖ Save Entries {% endif %}
</button>

</form>
</div>

<!-- ================= STYLES ================= -->
<style>
:root{
  --lemon:#facc15;
  --lemon-soft:#fff7cc;
}

.animate-page{animation:fadeUp .35s ease-out}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1}}

.section-title{font-size:1.15rem;font-weight:800}
.card{background:white;border:1px solid #e5e7eb;border-radius:1.25rem;overflow:hidden}
.header-row{background:#f8fafc;font-size:.75rem;font-weight:700;padding:.6rem}
.data-row{padding:.5rem;transition:.2s}
.data-row:hover{background:var(--lemon-soft)}

.input-box{border:1px solid #d1d5db;border-radius:.5rem;padding:.35rem;text-align:center}
.input-box:focus{outline:none;border-color:var(--lemon);box-shadow:0 0 0 3px rgba(250,204,21,.35)}

.rate-box{background:#f1f5f9;border-radius:.5rem;font-weight:700;text-align:center;padding:.35rem}
.advance-box{background:#fffbe6;border:1px solid var(--lemon);font-weight:800;border-radius:.5rem;text-align:center;padding:.35rem}
.labour-box{background:#fef3c7;font-weight:800;text-align:center;border-radius:.5rem;padding:.35rem}
.total-box{background:#dcfce7;font-weight:900;text-align:center;border-radius:.5rem;padding:.35rem}

.save-btn{
  background:linear-gradient(to right,var(--lemon),#fde047);
  color:#422006;
  font-weight:900;
  padding:1rem;
  border-radius:1.25rem;
  transition:.25s;
}
.save-btn:hover{transform:translateY(-2px);box-shadow:0 12px 25px rgba(0,0,0,.2)}

.reset-btn{background:#fee2e2;color:#b91c1c;padding:.5rem 1rem;border-radius:.75rem;font-weight:700}
.reset-link{display:block;padding:.5rem .75rem;font-size:.85rem}
.reset-link:hover{background:#f1f5f9}

.date-input{border:1px solid #d1d5db;border-radius:.75rem;padding:.5rem}
.delete-btn{background:#fee2e2;color:#b91c1c;border-radius:.5rem;padding:.25rem;font-size:.8rem;font-weight:700}
.btn-green{background:#16a34a;color:white;padding:.5rem 1rem;border-radius:.75rem;font-weight:700}
</style>
<!-- ================= JS ================= -->
<script>

function calcCivil(id, masonRate, helperRate) {

  const mf = +document.querySelector(`[name="mason_full_${id}"]`)?.value || 0;
  const hf = +document.querySelector(`[name="helper_full_${id}"]`)?.value || 0;
  const mh = +document.querySelector(`[name="mason_half_${id}"]`)?.value || 0;
  const hh = +document.querySelector(`[name="helper_half_${id}"]`)?.value || 0;
  
  const advance = +document.querySelector(`[name="advance_${id}"]`)?.value || 0;

  const labour =
    (mf * masonRate) +
    (mh * masonRate / 2) +
    (hf * helperRate) +
    (hh * helperRate / 2);

  
  const total = labour - advance;
  document.getElementById(`civil_labour_${id}`).innerText = labour;
  document.getElementById(`civil_total_${id}`).innerText = total;
}

function calcDept(id, rate) {
  let full = +document.querySelector(`[name="dept_full_${id}"]`)?.value || 0;
  let half = +document.querySelector(`[name="dept_half_${id}"]`)?.value || 0;
  let advance = +document.querySelector(`[name="dept_advance_${id}"]`)?.value || 0;

  let labour = (full * rate) + (half * rate / 2);
  let total = labour - advance;

  document.getElementById(`dept_labour_${id}`).innerText = labour;
  document.getElementById(`dept_total_${id}`).innerText = total;
}


function toggleResetMenu(id) {
  const menu = document.getElementById("resetMenu" + id);

  // Close all menus first
  document.querySelectorAll("[id^='resetMenu']").forEach(m => {
    if (m !== menu) m.classList.add("hidden");
  });

  // Toggle selected menu
  menu.classList.toggle("hidden");
}

// Close menu when clicking outside
document.addEventListener("click", function (e) {
  const isButton = e.target.closest("[onclick^='toggleResetMenu']");
  const isMenu = e.target.closest("[id^='resetMenu']");

  if (!isButton && !isMenu) {
    document.querySelectorAll("[id^='resetMenu']").forEach(m =>
      m.classList.add("hidden")
    );
  }
});
function resetByDate(siteId) {
  const date = document.getElementById("work_date").value;

  if (!date) {
    alert("Please select a date first");
    return;
  }

  if (!confirm("Reset entries for selected date?")) return;

  window.location.href = `/site/${siteId}/reset/date/?date=${date}`;
}


function goToEdit(siteId) {
  const dateInput = document.getElementById("work_date");

  if (!dateInput || !dateInput.value) {
    alert("Please select a date");
    return;
  }

  const date = dateInput.value;

  // Force navigation
  window.location.href = `/site/${siteId}/?date=${encodeURIComponent(date)}`;
}



let materialIndex = {{ materials|length }};

function addMaterialRow() {
  const container = document.getElementById("materialRows");

  const row = document.createElement("div");
  row.className = "grid grid-cols-7 gap-2 items-center mb-2";

  row.innerHTML = `
    <input name="agent_name_${materialIndex}" class="input-box">
    <input name="material_name_${materialIndex}" class="input-box">
    <input name="material_qty_${materialIndex}" type="floatformat" class="input-box" oninput="calcMaterial(${materialIndex})">
    <input name="material_unit_${materialIndex}" class="input-box">
    <input name="material_rate_${materialIndex}" type="number" class="input-box" oninput="calcMaterial(${materialIndex})">
    <input id="material_total_${materialIndex}" class="input-box bg-green-100 font-bold" readonly>
    <button type="button" onclick="this.parentElement.remove()" class="text-red-600 bg-red-100 rounded py-1 font-bold">Delete</button>
  `;

  container.appendChild(row);
  materialIndex++;
}

function calcMaterial(index) {
  const qty = Number(document.querySelector(`[name="material_qty_${index}"]`)?.value || 0);
  const rate = Number(document.querySelector(`[name="material_rate_${index}"]`)?.value || 0);
  document.getElementById(`material_total_${index}`).value = qty * rate;
}
</script>

{% endblock %}
