{% extends "base.html" %}
{% block content %}

<!-- ================= HEADER ================= -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
  <h2 class="text-2xl font-bold text-slate-800">
    {{ site.name }} â€“ Daily Entry
  </h2>

  <div class="flex gap-2 items-center">
    <input type="date"
           id="work_date"
           value="{{ today|date:'Y-m-d' }}"
           class="border rounded-lg px-3 py-2">

    <button onclick="goToEdit({{ site.id }})"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
      âœ Edit
    </button>

    <!-- RESET -->
    <div class="relative">
      <button onclick="toggleResetMenu({{ site.id }})"
              class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-semibold">
        Reset â–¾
      </button>

      <div id="resetMenu{{ site.id }}"
           class="hidden absolute right-0 mt-2 w-48 bg-white border rounded-xl shadow z-50">
        <a href="{% url 'reset_site_today' site.id %}"
           onclick="return confirm('Reset today entries?')"
           class="block px-4 py-2 hover:bg-gray-100">ğŸ”„ Reset Today</a>
        <a href="{% url 'reset_site_month' site.id %}"
           onclick="return confirm('Reset this month entries?')"
           class="block px-4 py-2 hover:bg-gray-100">ğŸ“… Reset Month</a>
        <div class="border-t"></div>
        <a href="{% url 'reset_site_all' site.id %}"
           onclick="return confirm('Delete ALL entries permanently?')"
           class="block px-4 py-2 text-red-600 hover:bg-red-50 font-semibold">
          ğŸ—‘ Reset All
        </a>
      </div>
    </div>
  </div>
</div>

<form method="post">
{% csrf_token %}
<input type="hidden" name="date" value="{{ today|date:'Y-m-d' }}">

<!-- ================================================= -->
<!-- ================= CIVIL TEAMS =================== -->
<!-- ================================================= -->

<h3 class="text-blue-700 font-bold mb-4">ğŸ‘· Civil Teams</h3>

<!-- ========== MOBILE VIEW (CARDS) ========== -->
<div class="space-y-4 md:hidden">
  {% for row in civil_rows %}
  <div class="bg-white rounded-2xl shadow p-4">

    <h4 class="font-semibold text-gray-800 mb-2">
      {{ row.team.name }}
    </h4>

    <div class="grid grid-cols-2 gap-2 text-sm">
      <input name="mason_full_{{ row.team.id }}" placeholder="Mason Full"
             type="number" min="0" class="border p-3 rounded-lg"
             oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

      <input name="mason_half_{{ row.team.id }}" placeholder="Mason Half"
             type="number" min="0" class="border p-3 rounded-lg"
             oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

      <input name="helper_full_{{ row.team.id }}" placeholder="Helper Full"
             type="number" min="0" class="border p-3 rounded-lg"
             oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

      <input name="helper_half_{{ row.team.id }}" placeholder="Helper Half"
             type="number" min="0" class="border p-3 rounded-lg"
             oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">
    </div>

    <input name="material_{{ row.team.id }}" placeholder="Material â‚¹"
           type="number" min="0"
           class="border p-3 rounded-lg w-full mt-2"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <div class="flex justify-between mt-3 text-sm font-semibold">
      <span>Labour â‚¹ <span id="civil_labour_{{ row.team.id }}">0</span></span>
      <span>Total â‚¹ <span id="civil_total_{{ row.team.id }}">0</span></span>
    </div>

  </div>
  {% endfor %}
</div>

<!-- ========== DESKTOP VIEW (GRID) ========== -->
<div class="hidden md:block bg-white rounded-2xl shadow p-4 mb-8">
  <div class="grid grid-cols-10 gap-2 text-xs font-semibold text-gray-600 mb-2">
    <div>Team</div>
    <div>M F</div>
    <div>H F</div>
    <div>M H</div>
    <div>H H</div>
    <div>Mason â‚¹</div>
    <div>Helper â‚¹</div>
    <div>Labour â‚¹</div>
    <div>Material â‚¹</div>
    <div>Total â‚¹</div>
  </div>

  {% for row in civil_rows %}
  <div class="grid grid-cols-10 gap-2 mb-3 items-center">
    <div class="font-medium">{{ row.team.name }}</div>

    <input name="mason_full_{{ row.team.id }}" value="0" type="number"
           class="border p-2 rounded"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input name="helper_full_{{ row.team.id }}" value="0" type="number"
           class="border p-2 rounded"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input name="mason_half_{{ row.team.id }}" value="0" type="number"
           class="border p-2 rounded"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input name="helper_half_{{ row.team.id }}" value="0" type="number"
           class="border p-2 rounded"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input value="{{ row.rate.mason_full_rate }}" readonly
           class="border p-2 bg-gray-100 text-center">

    <input value="{{ row.rate.helper_full_rate }}" readonly
           class="border p-2 bg-gray-100 text-center">

    <input id="civil_labour_{{ row.team.id }}" value="0" readonly
           class="border p-2 bg-yellow-100 font-semibold">

    <input name="material_{{ row.team.id }}" value="0" type="number"
           class="border p-2 rounded"
           oninput="calcCivil({{ row.team.id }}, {{ row.rate.mason_full_rate }}, {{ row.rate.helper_full_rate }})">

    <input id="civil_total_{{ row.team.id }}" value="0" readonly
           class="border p-2 bg-green-100 font-bold">
  </div>
  {% endfor %}
</div>

<!-- ================================================= -->
<!-- ================= OTHER DEPARTMENTS ============== -->
<!-- ================================================= -->

<h3 class="text-orange-600 font-bold mb-4">ğŸ¢ Other Departments</h3>

<div class="bg-white rounded-2xl shadow p-4 mb-8">
  {% for dept in other_depts %}
    {% for rate in default_rates %}
      {% if rate.department_id == dept.id %}
      <div class="flex flex-col md:grid md:grid-cols-7 gap-2 mb-4">

        <div class="font-medium">{{ dept.name }}</div>

        <input name="dept_full_{{ dept.id }}" placeholder="Full"
               type="number" min="0"
               class="border p-3 rounded-lg"
               oninput="calcDept({{ dept.id }}, {{ rate.full_day_rate }})">

        <input name="dept_half_{{ dept.id }}" placeholder="Half"
               type="number" min="0"
               class="border p-3 rounded-lg"
               oninput="calcDept({{ dept.id }}, {{ rate.full_day_rate }})">

        <input value="{{ rate.full_day_rate }}" readonly
               class="border p-3 bg-gray-100 rounded-lg text-center">

        <input id="dept_labour_{{ dept.id }}" value="0" readonly
               class="border p-3 bg-yellow-100 rounded-lg font-semibold">

        <input name="dept_material_{{ dept.id }}" placeholder="Material â‚¹"
               type="number" min="0"
               class="border p-3 rounded-lg"
               oninput="calcDept({{ dept.id }}, {{ rate.full_day_rate }})">

        <input id="dept_total_{{ dept.id }}" value="0" readonly
               class="border p-3 bg-green-100 rounded-lg font-bold">
      </div>
      {% endif %}
    {% endfor %}
  {% endfor %}
</div>

<!-- ================= SAVE ================= -->
<button type="submit"
        class="w-full bg-orange-600 hover:bg-orange-700 text-white py-4 rounded-xl font-bold text-lg">
  âœ… Save All Entries
</button>

</form>


<!-- ================= JAVASCRIPT ================= -->
<script>
function calcCivil(id, masonRate, helperRate) {
  let mf = +document.querySelector(`[name="mason_full_${id}"]`).value || 0;
  let mh = +document.querySelector(`[name="mason_half_${id}"]`).value || 0;
  let hf = +document.querySelector(`[name="helper_full_${id}"]`).value || 0;
  let hh = +document.querySelector(`[name="helper_half_${id}"]`).value || 0;
  let material = +document.querySelector(`[name="material_${id}"]`).value || 0;

  let labour = (mf*masonRate)+(mh*(masonRate/2))+(hf*helperRate)+(hh*(helperRate/2));
  let total = (labour > 0) ? labour + material : 0;

  document.getElementById(`civil_labour_${id}`).value = labour;
  document.getElementById(`civil_total_${id}`).value = total;
}

function calcDept(id, rate) {
  let full = +document.querySelector(`[name="dept_full_${id}"]`).value || 0;
  let half = +document.querySelector(`[name="dept_half_${id}"]`).value || 0;
  let material = +document.querySelector(`[name="dept_material_${id}"]`).value || 0;

  let labour = (full || half) ? (full*rate)+(half*(rate/2)) : 0;
  let total = (labour > 0) ? labour + material : 0;

  document.getElementById(`dept_labour_${id}`).value = labour;
  document.getElementById(`dept_total_${id}`).value = total;
}

function toggleResetMenu(id) {
  const menu = document.getElementById("resetMenu"+id);
  document.querySelectorAll("[id^='resetMenu']").forEach(m => m.classList.add("hidden"));
  menu.classList.toggle("hidden");
}

function goToEdit(siteId) {
  const date = document.getElementById("work_date").value;
  if (!date) return alert("Select date");
  window.location.href = `/site/${siteId}/edit/?date=${date}`;
}

document.addEventListener("keydown", e => {
  if (e.key === "Enter") e.preventDefault();
});
</script>

{% endblock %}
