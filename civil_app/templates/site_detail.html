{% extends "base.html" %}
{% load civil_extras %}
{% block content %}

<!-- PREMIUM PAGE BACKDROP -->

<div class="fixed inset-0 -z-10 bg-gradient-to-br
            from-slate-50 via-white to-amber-50"></div>

<div class="page-container max-w-7xl mx-auto px-4 py-6 space-y-8 animate-page">

  <!-- ================= HEADER ================= -->

  <div class="premium-header">


<div>
  <h2 class="page-title">
    <span class="emoji">üèó</span>

    <div class="site-wrap">
      <select id="siteSwitcher"
              onchange="switchSite()"
              class="site-switcher">
        {% for s in sites %}
          <option value="{{ s.id }}"
            {% if s.id == site.id %}selected{% endif %}>
            {{ s.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <span class="title-sub">‚Äì Daily Entry</span>
  </h2>

  <p class="text-sm text-gray-500 mt-1">
    Enter labour, advances and materials
  </p>
</div>

<div class="top-actions">
  <input type="date"
         id="work_date"
         value="{{ work_date|date:'Y-m-d' }}"
         onchange="goToEdit({{ site.id }})"
         class="date-input-modern">

  <!-- RESET -->
  <div class="relative">
    <button onclick="toggleResetMenu({{ site.id }})"
            class="reset-btn-modern">
      Reset ‚ñæ
    </button>

    <div id="resetMenu{{ site.id }}"
         class="hidden absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border z-50">
      <a href="{% url 'reset_site_today' site.id %}"
         onclick="return confirm('Reset today entries?')"
         class="reset-link">üîÑ Reset Today</a>

      <a href="{% url 'reset_site_month' site.id %}"
         onclick="return confirm('Reset this month entries?')"
         class="reset-link">üìÖ Reset Month</a>

      <a href="#"
         onclick="resetByDate({{ site.id }})"
         class="reset-link text-orange-600">
        üìÜ Reset Selected Date
      </a>

      <div class="border-t"></div>

      <a href="{% url 'reset_site_all' site.id %}"
         onclick="return confirm('Delete ALL entries?')"
         class="reset-link text-red-600 font-semibold">
        üóë Reset All
      </a>
    </div>
  </div>

  <!-- SMART COPY -->
  <button type="button"
          onclick="openCopyModal({{ site.id }})"
          class="btn-green-modern">
    üìã Smart Copy
  </button>
  <!-- ===== INLINE TOTAL ===== -->
<div id="liveTotalBar" class="inline-total">

  <span class="inline-total-label">
    üí∞ Total
  </span>

  <span id="liveGrandTotal" class="inline-total-amount">
    ‚Çπ0
  </span>

</div>
</div>


  </div>

  <!-- ================= DAILY DESCRIPTION ================= -->

  <div id="descPreviewCard" class="glass-card p-4">
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-xs font-bold text-indigo-600 tracking-wide">
          üìù DAILY NOTE
        </p>


    <p id="descPreviewText"
       class="text-sm text-slate-700 font-medium mt-1 whitespace-pre-line">
      {{ daily_description|default_if_none:""|default:"No description added for this day." }}
    </p>
  </div>

  <button type="button"
          onclick="openDescModal()"
          class="chip-btn">
    Edit
  </button>
</div>


  </div>

  <!-- ===== LIVE TOTAL BAR ===== -->

  

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="date" value="{{ work_date|date:'Y-m-d' }}">
    <input type="hidden" name="daily_description" id="daily_description_input"
           value="{{ daily_description|default:'' }}">


{% include "site/partials/_civil_section.html" %}
{% include "site/partials/_dept_section.html" %}
{% include "site/partials/_material_section.html" %}
{% include "site/partials/_expense_section.html" %}

<button type="submit" class="save-btn w-full">
  {% if request.GET.date %} üîÑ Update Entries {% else %} ‚úÖ Save Entries {% endif %}
</button>


  </form>
</div>
<!-- ================= DESCRIPTION MODAL ================= -->
<div id="descModal"
     class="hidden fixed inset-0 z-50 items-center justify-center bg-black/40 backdrop-blur-sm">

  <div class="modal-card w-full max-w-lg">

    <!-- header -->
    <div class="modal-head">
      <h3>üìù Daily Description</h3>
      <button type="button" onclick="closeDescModal()" class="modal-close">‚úï</button>
    </div>

    <!-- body -->
    <div class="p-4">
      <textarea id="daily_description_text"
                rows="5"
                class="modal-textarea"
                placeholder="Enter today work description..."></textarea>
    </div>

    <!-- footer -->
    <div class="modal-footer">
      <button type="button"
              onclick="closeDescModal()"
              class="modal-btn cancel">
        Cancel
      </button>

      <button type="button"
              onclick="saveDescription()"
              class="modal-btn save">
        Save
      </button>
    </div>

  </div>
</div>

<!-- ================= SMART COPY MODAL ================= -->
<div id="copyModal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">

  <div class="modal-card w-full max-w-md">

    <!-- header -->
    <div class="modal-head">
      <h3>üìã Smart Copy</h3>
      <button type="button" onclick="closeCopyModal()" class="modal-close">‚úï</button>
    </div>

    <!-- body -->
    <div class="p-4 space-y-3 text-sm font-semibold text-slate-700">

      <label class="modal-check">
        <input type="checkbox" id="copyCivil" checked>
        Civil Labour
      </label>

      <label class="modal-check">
        <input type="checkbox" id="copyDept" checked>
        Department Labour
      </label>

      <label class="modal-check">
        <input type="checkbox" id="copyMaterial" checked>
        Materials
      </label>

      <label class="modal-check">
        <input type="checkbox" id="copyDesc">
        Daily Description
      </label>

      <label class="modal-check text-red-600">
        <input type="checkbox" id="copyReplace">
        Replace today if exists
      </label>

    </div>

    <!-- footer -->
    <div class="modal-footer">
      <button type="button"
              onclick="closeCopyModal()"
              class="modal-btn cancel">
        Cancel
      </button>

      <button type="button"
              onclick="runSmartCopy()"
              class="modal-btn save">
        Copy Now
      </button>
    </div>

  </div>
</div>
<!-- ================= STYLES ================= -->

<style>
/* ================= GLOBAL RESET ================= */
*{
  box-sizing:border-box;
}

html,body{
  overflow-x:hidden;
  background:#f3f4f6;
  font-family: Inter, system-ui, -apple-system, sans-serif;
  color:#0f172a;
}

/* ================= PAGE CONTAINER ================= */
.page-container{
  width:100%;
  max-width:1200px;
  margin:auto;
  padding:20px;
}

@media (max-width:640px){
  .page-container{
    padding:12px;
  }
}

/* ================= HEADER ================= */
.premium-header{
  display:flex;
  flex-direction:column;
  gap:14px;
  margin-bottom:10px;
}

@media (min-width:768px){
  .premium-header{
    flex-direction:row;
    justify-content:space-between;
    align-items:center;
  }
}

/* ================= TITLE ================= */
.page-title{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:8px;
  font-size:1.4rem;
  font-weight:900;
}

@media (max-width:640px){
  .page-title{
    font-size:1.15rem;
  }
}

/* ================= ACTION ROW ================= */
.top-actions{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
}

@media (max-width:640px){
  .top-actions{
    flex-direction:column;
    align-items:stretch;
  }

  .top-actions > *{
    width:100%;
  }
}

/* ================= GLASS CARD ================= */
.glass-card{
  background:#ffffff;
  border-radius:16px;
  border:1px solid #e5e7eb;
  box-shadow:0 10px 30px rgba(0,0,0,.06);
  padding:16px;
}

/* ================= SECTION CARDS ================= */
.section-card{
  background:#ffffff;
  border-radius:14px;
  border:1px solid #e5e7eb;
  box-shadow:0 6px 18px rgba(0,0,0,.05);
  overflow:hidden;
  margin-bottom:16px;
}

/* ================= SECTION HEADER ================= */
.section-title{
  font-weight:800;
  font-size:1rem;
  padding:14px 16px;
  background:#f8fafc;
  border-bottom:1px solid #e5e7eb;
}

/* ================= TABLE ================= */
.table-wrap{
  overflow:auto;
}

.modern-table{
  width:100%;
  border-collapse:collapse;
  font-size:.9rem;
  min-width:720px;
}

.modern-table th{
  background:#0f172a;
  color:white;
  padding:10px 8px;
  font-size:.75rem;
  text-transform:uppercase;
  letter-spacing:.05em;
  white-space:nowrap;
}

.modern-table td{
  padding:10px 8px;
  border-bottom:1px solid #f1f5f9;
}

.modern-table tbody tr:hover{
  background:#f8fafc;
}

/* ================= INPUTS ================= */
input[type="number"],
input[type="text"],
select{
  border:1px solid #e5e7eb;
  border-radius:8px;
  padding:6px 8px;
  font-weight:600;
  width:100%;
  background:white;
}

input:focus,
select:focus{
  outline:none;
  border-color:#f59e0b;
  box-shadow:0 0 0 2px rgba(245,158,11,.15);
}

/* ================= DATE ================= */
.date-input-modern{
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:8px 10px;
  font-weight:700;
  background:white;
}

/* ================= SITE SWITCH ================= */
.site-switcher{
  width:100%;
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:8px 10px;
  font-weight:800;
  background:white;
}

/* ================= BUTTONS ================= */
.btn-green-modern{
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:white;
  font-weight:800;
  padding:8px 14px;
  border-radius:10px;
  box-shadow:0 6px 16px rgba(34,197,94,.35);
  transition:.2s;
}

.btn-green-modern:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 24px rgba(34,197,94,.45);
}

.reset-btn-modern{
  background:linear-gradient(135deg,#ef4444,#dc2626);
  color:white;
  font-weight:800;
  padding:8px 14px;
  border-radius:10px;
  box-shadow:0 6px 16px rgba(220,38,38,.35);
}

/* ================= INLINE TOTAL ================= */
.inline-total{
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 12px;
  border-radius:10px;
  border:1px solid #fde68a;
  background:#fffbeb;
  font-weight:900;
}

.inline-total-amount{
  color:#166534;
  font-size:1rem;
}

@media (max-width:640px){
  .inline-total{
    justify-content:center;
  }
}

/* ================= SAVE BUTTON (APP STYLE) ================= */
.save-btn{
  background:linear-gradient(135deg,#facc15,#f59e0b);
  color:#422006;
  font-weight:900;
  padding:18px;
  border-radius:18px;
  box-shadow:0 20px 45px rgba(245,158,11,.35);
  font-size:1.05rem;
  width:100%;
  margin-top:10px;
}

/* ‚≠ê MOBILE FLOAT SAVE */
@media (max-width:640px){
  .save-btn{
    position:fixed;
    left:12px;
    right:12px;
    bottom:12px;
    z-index:60;
  }

  body{
    padding-bottom:100px;
  }
}

/* ================= MODAL ================= */
.modal-card{
  background:white;
  border-radius:16px;
  box-shadow:0 30px 80px rgba(0,0,0,.25);
  width:100%;
  max-width:420px;
}

.modal-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 18px;
  border-bottom:1px solid #e5e7eb;
  font-weight:800;
}

.modal-footer{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  padding:12px 16px;
  border-top:1px solid #e5e7eb;
}

@media (max-width:640px){
  .modal-card{
    width:92%;
  }

  .modal-footer{
    flex-direction:column;
  }

  .modal-btn{
    width:100%;
  }
}

</style>

<!-- ================= JS ================= -->

<script>

function money(n){
  return "‚Çπ" + Number(n || 0).toLocaleString("en-IN");
}

/* ================= CIVIL ================= */
function calcCivil(id, masonRate, helperRate) {

  const mf = +document.querySelector(`[name="mason_full_${id}"]`)?.value || 0;
  const hf = +document.querySelector(`[name="helper_full_${id}"]`)?.value || 0;
  const mh = +document.querySelector(`[name="mason_half_${id}"]`)?.value || 0;
  const hh = +document.querySelector(`[name="helper_half_${id}"]`)?.value || 0;
  const advance = +document.querySelector(`[name="advance_${id}"]`)?.value || 0;

  const labour =
    (mf * masonRate) +
    (mh * masonRate / 2) +
    (hf * helperRate) +
    (hh * helperRate / 2);

  const total = Math.max(labour - advance);

  document.getElementById(`civil_labour_${id}`).innerText =
    labour.toLocaleString("en-IN");

  document.getElementById(`civil_total_${id}`).innerText =
    total.toLocaleString("en-IN");

  updateLiveGrandTotal();
}

/* ================= DEPT ================= */
function calcDept(id) {
  let full = +document.querySelector(`[name="dept_full_${id}"]`)?.value || 0;
  let half = +document.querySelector(`[name="dept_half_${id}"]`)?.value || 0;
  let advance = +document.querySelector(`[name="dept_advance_${id}"]`)?.value || 0;
  let rate = +document.querySelector(`[name="dept_rate_${id}"]`)?.value || 0;

  let labour = (full * rate) + (half * rate / 2);
  let total = Math.max(labour - advance, 0);

  document.getElementById(`dept_labour_${id}`).innerText =
    labour.toLocaleString("en-IN");

  document.getElementById(`dept_total_${id}`).innerText =
    total.toLocaleString("en-IN");

  updateLiveGrandTotal();
}

/* ================= LIVE GRAND ================= */

function updateLiveGrandTotal(){
  let total = 0;

  // ===== CIVIL =====
  document.querySelectorAll('[id^="civil_total_"]').forEach(el=>{
    total += Number((el.innerText || "0").replace(/,/g,'')) || 0;
  });

  // ===== DEPT =====
  document.querySelectorAll('[id^="dept_total_"]').forEach(el=>{
    total += Number((el.innerText || "0").replace(/,/g,'')) || 0;
  });

  // ===== MATERIAL =====
  document.querySelectorAll('[id^="material_total_"]').forEach(el=>{
    total += Number(el.value || 0);
  });

  // ‚úÖ ‚úÖ EXPENSE (VERY IMPORTANT)
  document.querySelectorAll('[name^="expense_amount_"]').forEach(el=>{
    total += Number(el.value || 0);
  });

  // ===== UPDATE UI =====
  const grand = document.getElementById("liveGrandTotal");
  if (grand){
    grand.innerText = "‚Çπ" + total.toLocaleString("en-IN");
  }
}

/* auto triggers */
document.addEventListener("input", updateLiveGrandTotal);
document.addEventListener("DOMContentLoaded", updateLiveGrandTotal);


/* ================= RESET MENU ================= */
function toggleResetMenu(id) {
  const menu = document.getElementById("resetMenu" + id);
  document.querySelectorAll("[id^='resetMenu']").forEach(m => {
    if (m !== menu) m.classList.add("hidden");
  });
  menu.classList.toggle("hidden");
}

/* ================= NAV ================= */
function goToEdit(siteId) {
  const date = document.getElementById("work_date").value;
  if (!date) return alert("Please select a date");
  window.location.href = `/site/${siteId}/?date=${encodeURIComponent(date)}`;
}

function switchSite() {
  const siteId = document.getElementById("siteSwitcher").value;
  const date = document.getElementById("work_date")?.value;
  let url = `/site/${siteId}/`;
  if (date) url += `?date=${date}`;
  window.location.href = url;
}

/* ================= SMART COPY ================= */

let currentSiteId = null;

function openCopyModal(siteId){
  currentSiteId = siteId;

  const modal = document.getElementById("copyModal");
  if (!modal) return;

  modal.classList.remove("hidden");
  modal.classList.add("flex");
}

/* ================= SMART COPY SELECTED ================= */
function runSmartCopy() {
  const date = document.getElementById("work_date")?.value;
  if (!date) return alert("‚ö†Ô∏è Select date first");

  const params = new URLSearchParams({
    date: date,
    civil: document.getElementById("copyCivil")?.checked ? 1 : 0,
    dept: document.getElementById("copyDept")?.checked ? 1 : 0,
    material: document.getElementById("copyMaterial")?.checked ? 1 : 0,
    desc: document.getElementById("copyDesc")?.checked ? 1 : 0,
    replace: document.getElementById("copyReplace")?.checked ? 1 : 0,
  });

  window.location.href =
    `/site/${currentSiteId}/copy-previous/?${params.toString()}`;
}


function openDescModal(){
  const modal = document.getElementById("descModal");
  if (!modal) return;

  // show modal
  modal.classList.remove("hidden");
  modal.classList.add("flex");

  // load existing text
  const hiddenVal = document.getElementById("daily_description_input")?.value || "";
  const textarea = document.getElementById("daily_description_text");
  if (textarea) textarea.value = hiddenVal;
}
function closeDescModal(){
  const modal = document.getElementById("descModal");
  if (!modal) return;

  modal.classList.add("hidden");
  modal.classList.remove("flex");
}
function saveDescription(){
  const textarea = document.getElementById("daily_description_text");
  const hiddenInput = document.getElementById("daily_description_input");
  const preview = document.getElementById("descPreviewText");

  if (!textarea || !hiddenInput) {
    console.error("Description elements missing");
    return;
  }

  const text = textarea.value.trim();

  // ‚úÖ update hidden input (THIS IS WHAT DJANGO SAVES)
  hiddenInput.value = text;

  // ‚úÖ update preview UI
  if (preview){
    preview.innerText = text || "No description added for this day.";
  }

  // ‚úÖ close modal
  closeDescModal();
}
function closeCopyModal(){
  const modal = document.getElementById("copyModal");
  if (!modal) return;

  modal.classList.add("hidden");
  modal.classList.remove("flex");
}
document.addEventListener("click", function(e){
  const modal = document.getElementById("copyModal");
  if (!modal) return;

  if (e.target === modal){
    closeCopyModal();
  }
});
</script>

{% endblock %}
