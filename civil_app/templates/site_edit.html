{% extends "base.html" %}
{% load civil_extras %}

{% block content %}

<!-- ================= HEADER ================= -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
  <h2 class="text-2xl font-bold text-gray-800">
    ‚úè Edit Daily Entry ‚Äì {{ site.name }}
  </h2>

  <form method="get" class="flex gap-3 items-end">
    <input type="date" id="work_date" onchange="goToEdit({{ site.id }})"
           class="border rounded-lg px-3 py-2">
    <button class="bg-blue-600 text-white px-4 py-2 rounded">
      Load
    </button>
  </form>
</div>

<form method="post">
{% csrf_token %}
<input type="hidden" name="date" value="{{ date|date:'Y-m-d' }}">

<!-- ================= CIVIL ================= -->
<h3 class="text-blue-700 font-bold mb-3">üë∑ Civil Teams</h3>

<div class="bg-white shadow rounded-xl p-4 mb-8">
  <div class="grid grid-cols-10 gap-2 text-xs font-semibold bg-gray-100 p-2 rounded">
    <div>Team</div>
    <div>M F</div>
    <div>H F</div>
    <div>M H</div>
    <div>H H</div>
    <div>Mason ‚Çπ</div>
    <div>Helper ‚Çπ</div>
    <div>Advance ‚Çπ</div>
    <div>Labour ‚Çπ</div>
    <div>Total ‚Çπ</div>
  </div>

  {% for row in civil_rows %}
  <div class="grid grid-cols-10 gap-2 items-center p-2 border-b">

    <div class="font-semibold">{{ row.team.name }}</div>

    <input name="mason_full_{{ row.team.id }}"
           value="{{ row.work.mason_full|default:0 }}"
           class="input-box">

    <input name="helper_full_{{ row.team.id }}"
           value="{{ row.work.helper_full|default:0 }}"
           class="input-box">

    <input name="mason_half_{{ row.team.id }}"
           value="{{ row.work.mason_half|default:0 }}"
           class="input-box">

    <input name="helper_half_{{ row.team.id }}"
           value="{{ row.work.helper_half|default:0 }}"
           class="input-box">

    <div class="rate-box">‚Çπ{{ row.rate.mason_full_rate }}</div>
    <div class="rate-box">‚Çπ{{ row.rate.helper_full_rate }}</div>

    <input name="advance_{{ row.team.id }}"
           value="{{ row.advance }}"
           class="input-box">

    <div class="labour-box">{{ row.labour }}</div>
    <div class="total-box">{{ row.total }}</div>
  </div>
  {% endfor %}
</div>

<!-- ================= DEPARTMENTS ================= -->
<h3 class="text-orange-600 font-bold mb-3">üè¢ Other Departments</h3>

<div class="bg-white shadow rounded-xl p-4 mb-8">
  <div class="grid grid-cols-6 gap-2 text-xs font-semibold bg-gray-100 p-2 rounded">
    <div>Department</div>
    <div>Full</div>
    <div>Half</div>
    <div>Rate</div>
    <div>Labour</div>
    <div>Total</div>
  </div>

  {% for dept in other_depts %}
    {% with row=dept_map|get_item:dept.id %}
    <div class="grid grid-cols-6 gap-2 p-2 items-center border-b">

      <div class="font-semibold">{{ dept.name }}</div>

      <input name="dept_full_{{ dept.id }}"
             value="{{ row.full_day_count|default:0 }}"
             class="input-box">

      <input name="dept_half_{{ dept.id }}"
             value="{{ row.half_day_count|default:0 }}"
             class="input-box">

      <div class="rate-box">
        ‚Çπ{{ rate_map|get_item:dept.id|default:"0" }}
      </div>

      <div class="labour-box">{{ row.labour_amount|default:0 }}</div>

      <div class="total-box">{{ row.labour_amount|default:0 }}</div>
    </div>
    {% endwith %}
  {% endfor %}
</div>

<!-- ================= MATERIAL ================= -->
<h3 class="text-green-700 font-bold mb-3">üß± Materials</h3>

<div class="bg-white shadow rounded-xl p-4 mb-8">
  <div class="grid grid-cols-6 gap-2 text-xs font-semibold mb-2">
    <div>Name</div>
    <div>Qty</div>
    <div>Unit</div>
    <div>Rate</div>
    <div>Total</div>
    <div></div>
  </div>

  <div id="materialRows">
    {% for m in materials %}
    <div class="grid grid-cols-6 gap-2 mb-2">
      <input name="material_name_{{ forloop.counter0 }}" value="{{ m.name }}" class="input-box">
      <input name="material_qty_{{ forloop.counter0 }}" value="{{ m.quantity }}" class="input-box">
      <input name="material_unit_{{ forloop.counter0 }}" value="{{ m.unit }}" class="input-box">
      <input name="material_rate_{{ forloop.counter0 }}" value="{{ m.rate }}" class="input-box">
      <input value="{{ m.total }}" readonly class="input-box bg-green-100">
      <button type="button" onclick="this.parentElement.remove()">‚ùå</button>
    </div>
    {% endfor %}
  </div>

  <button type="button" onclick="addMaterialRow()"
          class="mt-3 bg-green-600 text-white px-4 py-2 rounded">
    ‚ûï Add Material
  </button>
</div>

<!-- ================= SAVE ================= -->
<div class="flex justify-end">
  <button type="submit"
          class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded font-bold">
    ‚úÖ Update Entry
  </button>
</div>

</form>

<!-- ================= JS ================= -->
<script>
let materialIndex = {{ materials|length }};

function addMaterialRow() {
  const row = document.createElement("div");
  row.className = "grid grid-cols-6 gap-2 mb-2";

  row.innerHTML = `
    <input name="material_name_${materialIndex}" class="input-box">
    <input name="material_qty_${materialIndex}" class="input-box">
    <input name="material_unit_${materialIndex}" class="input-box">
    <input name="material_rate_${materialIndex}" class="input-box">
    <input class="input-box bg-green-100" readonly>
    <button type="button" onclick="this.parentElement.remove()">‚ùå</button>
  `;
  document.getElementById("materialRows").appendChild(row);
  materialIndex++;
}
function goToEdit(siteId) {
  const dateInput = document.getElementById("work_date");

  if (!dateInput || !dateInput.value) {
    alert("Please select a date");
    return;
  }

  const date = dateInput.value;

  // Force navigation
  window.location.href = `/site/${siteId}/edit/?date=${encodeURIComponent(date)}`;
}
</script>

{% endblock %}
