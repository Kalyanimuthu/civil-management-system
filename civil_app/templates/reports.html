{% extends "base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 md:px-6 py-6 md:py-8 space-y-8 md:space-y-10">

  <!-- ================= HEADER ================= -->

  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 md:gap-6">


<div>
  <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 flex items-center gap-3">
    üìä Reports Dashboard
  </h2>
  <p class="text-slate-500 mt-1 text-sm">
    Advanced expense & labour analytics
  </p>
</div>

<div class="flex flex-wrap gap-2 w-full sm:w-auto">
  <a href="{% url 'all_bills' %}" class="btn-soft-yellow">
    üìë View Bills
  </a>
  <button type="button"
        onclick="openDayModal()"
        class="btn-primary">
  üîç View Day Details
</button>
</div>


  </div>

  <!-- ================= GRID ================= -->

  <div class="dashboard-grid">


<!-- ================= FILTER PANEL ================= -->
<aside class="glass-card p-4 md:p-5 space-y-5 h-fit lg:sticky lg:top-6">

  <h3 class="font-bold text-slate-800 text-lg">üîç Filters</h3>

  <a href="{% url 'report_pdf' %}?from_date={{ from_date|date:'Y-m-d' }}&to_date={{ to_date|date:'Y-m-d' }}&site={{ selected_site }}&team={{ selected_team }}&department={{ selected_department }}"
     class="block text-center bg-yellow-400 hover:bg-yellow-500 text-slate-900 py-2 rounded-lg font-bold shadow">
    üìÑ Download PDF
  </a>

  <form method="get" class="space-y-4">

    <div>
      <label class="filter-label">From</label>
      <input type="date" name="from_date"
             value="{{ from_date|date:'Y-m-d' }}"
             class="filter-input">
    </div>

    <div>
      <label class="filter-label">To</label>
      <input type="date" name="to_date"
             value="{{ to_date|date:'Y-m-d' }}"
             class="filter-input">
    </div>

    <div>
      <label class="filter-label">Site</label>
      <select name="site" class="filter-input">
        <option value="">All</option>
        {% for s in sites %}
          <option value="{{ s.id }}" {% if selected_site == s.id|stringformat:"s" %}selected{% endif %}>
            {{ s.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="filter-label">Team</label>
      <select name="team" class="filter-input">
        <option value="">All</option>
        {% for t in teams %}
          <option value="{{ t.id }}" {% if selected_team == t.id|stringformat:"s" %}selected{% endif %}>
            {{ t.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="filter-label">Department</label>
      <select name="department" class="filter-input">
        <option value="">All</option>
        {% for d in departments %}
          <option value="{{ d.id }}" {% if selected_department == d.id|stringformat:"s" %}selected{% endif %}>
            {{ d.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <button class="btn-primary w-full">
      Apply Filters
    </button>

    <a href="{% url 'reports' %}" class="btn-secondary w-full text-center block">
      Reset
    </a>

  </form>
</aside>

<!-- ================= MAIN CONTENT ================= -->
<main class="dashboard-main space-y-6 md:space-y-8">

  <!-- KPI -->
  <div class="kpi-grid">

    <div class="kpi-card bg-orange-50 border-orange-200">
      <p class="kpi-label">Labour</p>
      <p class="kpi-value text-orange-600">‚Çπ{{ total_labour }}</p>
    </div>

    <div class="kpi-card bg-blue-50 border-blue-200">
      <p class="kpi-label">Material</p>
      <p class="kpi-value text-blue-600">‚Çπ{{ total_material }}</p>
    </div>

    <div class="kpi-card bg-red-50 border-red-200">
      <p class="kpi-label">Advance</p>
      <p class="kpi-value text-red-600">‚Çπ{{ total_advance }}</p>
    </div>

    <div class="kpi-card bg-yellow-50 border-yellow-300">
      <p class="kpi-label">Grand Total</p>
      <p class="kpi-value text-green-700">‚Çπ{{ grand_total }}</p>
    </div>

  </div>

  <!-- TABLE -->
  <div class="glass-card overflow-hidden">
    <div class="overflow-x-auto">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Site</th>
            <th>Department</th>
            <th>Team</th>
            <th class="text-right">Labour</th>
            <th class="text-right">Material</th>
            <th class="text-right">Advance</th>
            <th class="text-right">Total</th>
          </tr>
        </thead>

        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r.date|date:'Y-m-d' }}</td>
            <td class="font-semibold">{{ r.site.name }}</td>
            <td>{{ r.department }}</td>
            <td>{{ r.team }}</td>
            <td class="text-right text-orange-600">‚Çπ{{ r.labour }}</td>
            <td class="text-right text-blue-600">‚Çπ{{ r.material }}</td>
            <td class="text-right text-red-500">‚Çπ{{ r.advance }}</td>
            <td class="text-right font-bold text-green-700">‚Çπ{{ r.total }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center py-10 text-slate-400">
              No records found
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</main>


  </div>
</div>
<div id="dayModal"
     class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">

  <div class="bg-white rounded-2xl w-[95%] max-w-5xl p-6 max-h-[85vh] overflow-auto">

    <div class="flex justify-between mb-4">
      <h3 id="dayModalTitle" class="font-bold text-lg"></h3>
      <button onclick="closeDayModal()" class="text-red-600 text-xl">‚úï</button>
    </div>

    <div id="dayModalBody"></div>

  </div>
</div>
<style>

/* ===== CARDS ===== */
.glass-card{
  background:rgba(255,255,255,.9);
  backdrop-filter:blur(14px);
  border:1px solid #e5e7eb;
  border-radius:1rem;
  box-shadow:0 10px 28px rgba(0,0,0,.06);
}

.kpi-card{
  border-radius:1rem;
  padding:1rem;
  border:1px solid;
}

.kpi-label{
  font-size:.7rem;
  font-weight:800;
  color:#64748b;
  text-transform:uppercase;
}

.kpi-value{
  font-size:1.6rem;
  font-weight:900;
}

/* ===== FILTER ===== */
.filter-label{
  font-size:.7rem;
  font-weight:800;
  color:#64748b;
  text-transform:uppercase;
  margin-bottom:4px;
  display:block;
}

.filter-input{
  width:100%;
  border:1px solid #e5e7eb;
  border-radius:.6rem;
  padding:.5rem .6rem;
  font-size:.85rem;
}

/* ===== BUTTONS ===== */
.btn-primary{
  background:#0f172a;
  color:white;
  padding:.6rem;
  border-radius:.6rem;
  font-weight:700;
}

.btn-secondary{
  background:#f1f5f9;
  padding:.6rem;
  border-radius:.6rem;
  font-weight:600;
}

.btn-soft-yellow{
  background:#fef9c3;
  color:#854d0e;
  padding:.5rem .9rem;
  border-radius:.7rem;
  font-weight:700;
}

/* ===== TABLE ===== */
.modern-table{
  width:100%;
  border-collapse:collapse;
  font-size:.85rem;
}

.modern-table th{
  background:#0f172a;
  color:white;
  padding:.7rem;
  font-size:.7rem;
  text-transform:uppercase;
}

.modern-table td{
  padding:.7rem;
  border-bottom:1px solid #f1f5f9;
}

.modern-table tbody tr:hover{
  background:#f8fafc;
}

/* ================= MOBILE ================= */



/* ===== DASHBOARD GRID ===== */
.dashboard-grid{
  display:grid;
  grid-template-columns: 200px minmax(0,1fr);
  gap:24px;
  align-items:start; /* ‚≠ê important */
}

/* ===== MAIN SAFETY ===== */
.dashboard-main{
  min-width:0;
}
/* ================= SITE BLOCK ================= */

.site-block{
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:14px;
  margin-bottom:18px;
  background:#ffffff;
}

.site-title{
  font-weight:900;
  color:#1d4ed8;
  margin-bottom:8px;
  font-size:15px;
}

/* ================= TABLE TITLE ================= */

.tbl-title{
  font-weight:800;
  font-size:12px;
  margin:10px 0 4px;
  color:#374151;
}

/* ================= MINI TABLE ================= */

.mini-table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  margin-bottom:6px;
}

.mini-table th{
  background:#f1f5f9;
  font-weight:800;
  padding:6px;
  border:1px solid #e5e7eb;
  text-align:left;
}

.mini-table td{
  padding:6px;
  border:1px solid #eef2f7;
}

.mini-table tbody tr:nth-child(even){
  background:#fafafa;
}
/* ================= TABLET FIX ================= */
/* keep side-by-side until small mobile */

@media (max-width: 640px){

  .dashboard-grid{
    grid-template-columns: 1fr; /* stack ONLY on small phones */
  }

  .dashboard-grid aside{
    max-width:420px;
    margin:0 auto;
    position:relative !important;
    top:auto !important;
  }

}
@media (max-width:480px){
  .kpi-grid{
    grid-template-columns:1fr;
  }
}
.kpi-grid{
  display:grid;
  grid-template-columns: repeat(4,minmax(0,1fr));
  gap:16px;
}

@media (max-width:1024px){
  .kpi-grid{
    grid-template-columns: repeat(2,1fr);
  }
}

@media (max-width:640px){
  .kpi-grid{
    grid-template-columns: 1fr;
  }
}
</style>
<script>
function openDayModal(){

  const dateInput = document.querySelector("input[name='from_date']");
  const date = dateInput.value;

  if (!date){
    alert("Please select date");
    return;
  }

  const modal = document.getElementById("dayModal");
  const body = document.getElementById("dayModalBody");
  const title = document.getElementById("dayModalTitle");

  title.innerText = "Full Day Report ‚Äî " + date;
  body.innerHTML = "Loading...";

  modal.classList.remove("hidden");
  modal.classList.add("flex");

  fetch(`/api/day-full/?date=${date}`)
    .then(r => r.json())
    .then(data => {

      let html = "";

      data.sites.forEach(site => {

        html += `
        <div class="site-block">

          <div class="site-title">üìç ${site.site}</div>
        `;

        // ================= CIVIL =================
        if (site.civil.length){
          html += `
            <div class="tbl-title">üë∑ Civil Work</div>
            <table class="mini-table">
              <thead>
                <tr>
                  <th>Team</th>
                  <th>Mason F/H</th>
                  <th>Helper F/H</th>
                </tr>
              </thead>
              <tbody>
          `;

          site.civil.forEach(c=>{
            html += `
              <tr>
                <td>${c.team}</td>
                <td>${c.mason_full} / ${c.mason_half}</td>
                <td>${c.helper_full} / ${c.helper_half}</td>
              </tr>
            `;
          });

          html += `</tbody></table>`;
        }

        // ================= MATERIAL =================
        if (site.material.length){
          html += `
            <div class="tbl-title">üß± Material</div>
            <table class="mini-table">
              <thead>
                <tr>
                  <th>Agent</th>
                  <th>Description</th>
                  <th>Qty</th>
                </tr>
              </thead>
              <tbody>
          `;

          site.material.forEach(m=>{
            html += `
              <tr>
                <td>${m.agent}</td>
                <td>${m.description || "-"}</td>
                <td>${m.qty || "-"}</td>
              </tr>
            `;
          });

          html += `</tbody></table>`;
        }

        // ================= DEPARTMENT =================
        if (site.department.length){
          html += `
            <div class="tbl-title">üè¢ Department</div>
            <table class="mini-table">
              <thead>
                <tr>
                  <th>Department</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
          `;

          site.department.forEach(d=>{
            html += `
              <tr>
                <td>${d.department}</td>
                <td>${d.description || "-"}</td>
              </tr>
            `;
          });

          html += `</tbody></table>`;
        }

        // ================= EXPENSE =================
        if (site.expense.length){
          html += `
            <div class="tbl-title">üí∏ Expense</div>
            <table class="mini-table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Description</th>
                  <th>Owner</th>
                </tr>
              </thead>
              <tbody>
          `;

          site.expense.forEach(e=>{
            html += `
              <tr>
                <td>${e.title}</td>
                <td>${e.description || "-"}</td>
                <td>${e.owner}</td>
              </tr>
            `;
          });

          html += `</tbody></table>`;
        }

        html += `</div>`;
      });

      body.innerHTML = html || "<div>No data for this date</div>";
    });
}

function closeDayModal(){
  const modal = document.getElementById("dayModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}
</script>
{% endblock %}
