{% extends "base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 py-10 space-y-10 animate-fade">

  <!-- ================= HEADER ================= -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6">

    <div>
      <h2 class="text-3xl font-extrabold text-slate-900">
        üßæ All Bills & Payments
      </h2>
      <p class="text-sm text-gray-500 mt-1">
        Click a team / department / agent / expense to view details
      </p>
    </div>

    <!-- FILTER -->
    <form method="get"
          class="flex gap-4 items-end bg-white px-5 py-4 rounded-2xl shadow border">

      <div>
        <label class="label">From</label>
        <input type="date" name="from_date"
               value="{{ from_date }}"
               class="input">
      </div>

      <div>
        <label class="label">To</label>
        <input type="date" name="to_date"
               value="{{ to_date }}"
               class="input">
      </div>
      <button class="btn-primary">Apply</button>
      <a href="{% url 'all_bills_pdf' %}?from_date={{ from_date|date:'Y-m-d' }}&to_date={{ to_date|date:'Y-m-d' }}"
         class="btn-soft-red">
        üìÑ Download PDF
      </a>
      

    </form>
  </div>

  <!-- ================= CIVIL ================= -->
  <section class="bill-card">
    <h3 class="bill-title text-blue-700">üë∑ Civil Teams</h3>

    <table class="bill-table">
      <thead>
        <tr>
          <th>Team</th>
          <th>Advance</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for c in civil_bills %}
        <tr class="row-click"
            onclick="openBill('civil', {{ c.team__id }}, '{{ c.team__name|escapejs }}')">
          <td class="link">{{ c.team__name }}</td>
          <td class="amount-red">‚Çπ{{ c.total_advance|default:0 }}</td>
          <td class="amount-green">‚Çπ{{ c.total_amount }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="empty">No civil bills</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- ================= DEPARTMENT ================= -->
  <section class="bill-card">
    <h3 class="bill-title text-orange-600">üè¢ Departments</h3>

    <table class="bill-table">
      <thead>
        <tr>
          <th>Department</th>
          <th>Advance</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for d in dept_bills %}
        <tr class="row-click"
            onclick="openBill('dept', {{ d.department_id }}, '{{ d.department__name|escapejs }}')">
          <td class="link">{{ d.department__name }}</td>
          <td class="amount-red">‚Çπ{{ d.total_advance|default:0 }}</td>
          <td class="amount-green">‚Çπ{{ d.total_amount }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="empty">No department bills</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- ================= MATERIAL ================= -->
  <section class="bill-card">
    <h3 class="bill-title text-green-700">üß± Material Agents</h3>

    <table class="bill-table">
      <thead>
        <tr>
          <th>Agent</th>
          <th>Advance</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for m in material_bills %}
        <tr class="row-click"
            onclick="openBill('material', '{{ m.agent_name|escapejs }}', '{{ m.agent_name|escapejs }}')">
          <td class="link">{{ m.agent_name }}</td>
          <td class="amount-red">‚Çπ{{ m.total_advance|default:0 }}</td>
          <td class="amount-green">‚Çπ{{ m.total_amount }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="empty">No material bills</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- ================= OTHER EXPENSE ================= -->
  <section class="bill-card bill-card-expense">
    <h3 class="bill-title text-purple-700">üí∏ Other Expenses</h3>

    <table class="bill-table">
      <thead>
        <tr>
          <th>Expense</th>
          <th>Advance</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for e in expense_bills %}
        <tr class="row-click"
            onclick="openBill('expense', '{{ e.title|escapejs }}', '{{ e.title|escapejs }}')">
          <td class="link">{{ e.title }}</td>
          <td class="amount-red">‚Çπ{{ e.total_advance|default:0 }}</td>
          <td class="amount-green">‚Çπ{{ e.total_amount }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="empty">No other expenses</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

</div>

<!-- ================= MODAL ================= -->
<div id="billModal"
     class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm">

  <div class="bg-white rounded-2xl w-[92%] max-w-3xl p-6 shadow-2xl">

    <div class="flex justify-between items-center mb-4">
      <h3 id="modalTitle" class="font-bold text-lg"></h3>

      <div class="flex gap-3">
        <a id="pdfLink"
           target="_blank"
           class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-lg font-bold text-sm shadow">
          üìÑ Download PDF
        </a>

        <button onclick="closeModal()"
                class="text-red-600 font-bold text-xl">
          ‚úï
        </button>
      </div>
    </div>

    <table class="bill-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Site</th>
          <th>Owner</th>
          <th>Advance</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="modalBody"></tbody>
    </table>

  </div>
</div>

<!-- ================= JS ================= -->
<script>
function openBill(type, id, title) {

  const modal = document.getElementById("billModal");
  const body  = document.getElementById("modalBody");
  const titleEl = document.getElementById("modalTitle");
  const pdfLink = document.getElementById("pdfLink");

  titleEl.innerText = title;
  body.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  modal.classList.remove("hidden");
  modal.classList.add("flex");

  let apiUrl = "";
  let pdfUrl = "";

  if (type === "civil") {
    apiUrl = `/api/bill/civil/${id}/`;
    pdfUrl = `/bill/team/${id}/`;
  }

  if (type === "dept") {
    apiUrl = `/api/bill/department/${id}/`;
    pdfUrl = `/bill/department/${id}/`;
  }

  if (type === "material") {
    apiUrl = `/api/bill/material/${encodeURIComponent(id)}/`;
    pdfUrl = `/bill/agent/${encodeURIComponent(id)}/`;
  }

  if (type === "expense") {
    apiUrl = `/api/bill/expense/${encodeURIComponent(id)}/`;
    pdfUrl = `/bill/expense/${encodeURIComponent(id)}/`;
  }

  pdfLink.href = `${pdfUrl}?from_date={{ from_date }}&to_date={{ to_date }}&pdf=1`;

  fetch(`${apiUrl}?from_date={{ from_date }}&to_date={{ to_date }}`)
    .then(res => res.json())
    .then(data => {

      if (!data.length) {
        body.innerHTML = "<tr><td colspan='5'>No records</td></tr>";
        return;
      }

      let html = "";
      data.forEach(r => {
        html += `
          <tr>
            <td>${r.date}</td>
            <td>${r.site || '-'}</td>
            <td>${r.owner || '-'}</td>
            <td class="text-red-600">‚Çπ${r.advance || 0}</td>
            <td class="font-bold text-green-700">‚Çπ${r.total || 0}</td>
          </tr>
        `;
      });

      body.innerHTML = html;
    })
    .catch(() => {
      body.innerHTML = "<tr><td colspan='5'>Error loading data</td></tr>";
    });
}

function closeModal(){
  const modal = document.getElementById("billModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

document.getElementById("billModal").addEventListener("click", function (e) {
  if (e.target.id === "billModal") {
    closeModal();
  }
});
</script>

<!-- ================= STYLES ================= -->
<style>
  
.btn-soft-red{
  background:#fee2e2;
  color:#7f1d1d;
  padding:.5rem .9rem;
  border-radius:.7rem;
  font-weight:700;
}

.label{font-size:.7rem;font-weight:700;color:#64748b}
.input{border:1px solid #e5e7eb;border-radius:.6rem;padding:.45rem .6rem;font-size:.85rem}
.btn-primary{background:#2563eb;color:white;padding:.55rem 1.4rem;border-radius:.6rem;font-weight:800}
.bill-card{background:white;border-radius:18px;padding:1.5rem;border:1px solid #e5e7eb;box-shadow:0 10px 25px rgba(0,0,0,.05);transition:.25s}
.bill-card:hover{transform:translateY(-3px);box-shadow:0 20px 40px rgba(0,0,0,.08)}
.bill-card-expense{background:linear-gradient(180deg,#faf5ff,#ffffff)}
.bill-title{font-size:1.1rem;font-weight:900;margin-bottom:1rem}
.bill-table{width:100%;border-collapse:collapse}
.bill-table th{font-size:.7rem;text-transform:uppercase;color:#475569;text-align:left;padding:.7rem;border-bottom:1px solid #e5e7eb}
.bill-table td{padding:.75rem;border-bottom:1px solid #e5e7eb}
.row-click{cursor:pointer;transition:.18s}
.row-click:hover{background:#f8fafc}
.link{color:#2563eb;font-weight:800}
.amount-red{color:#dc2626;font-weight:800}
.amount-green{color:#16a34a;font-weight:900}
.empty{text-align:center;color:#94a3b8;padding:1rem}
</style>

{% endblock %}