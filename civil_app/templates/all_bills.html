{% extends "base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 py-10 space-y-10 animate-fade">

  <!-- ================= HEADER ================= -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6">

    <div>
      <h2 class="text-3xl font-extrabold text-slate-900">
        üßæ All Bills & Payments
      </h2>
      <p class="text-sm text-gray-500 mt-1">
        Click a team / department / agent / expense to view details
      </p>
    </div>

    <!-- FILTER -->
    <form method="get"
      class="flex flex-wrap sm:flex-nowrap items-end gap-3 bg-white px-4 py-4 rounded-2xl shadow border">

      <div class="flex flex-col min-w-[130px] flex-1 sm:flex-none">
        <label class="label">From</label>
        <input type="date" name="from_date"
              value="{{ from_date|date:'Y-m-d' }}"
              class="input w-full">
      </div>

      <div class="flex flex-col min-w-[130px] flex-1 sm:flex-none">
        <label class="label">To</label>
        <input type="date" name="to_date"
              value="{{ to_date|date:'Y-m-d' }}"
              class="input w-full">
      </div>
      
      <a href="{% url 'all_bills_pdf' %}?from_date={{ from_date|date:'Y-m-d' }}&to_date={{ to_date|date:'Y-m-d' }}"
        class="btn-soft-red flex-1 sm:flex-none text-center whitespace-nowrap">
        Download PDF
      </a>
      

    </form>
  </div>

  <!-- ================= CIVIL ================= -->
  <section class="bill-card">
    <h3 class="bill-title text-blue-700">üë∑ Civil Teams</h3>

    <table class="bill-table">
      <thead>
        <tr>
          <th class="text-left">Team</th>
          <th>Advance</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for c in civil_bills %}
        <tr class="row-click"
            onclick="openBill('civil', {{ c.team__id }}, '{{ c.team__name|escapejs }}')">
          <td class="link">{{ c.team__name }}</td>
          <td class="amount-red">‚Çπ{{ c.total_advance|default:0 }}</td>
          <td class="amount-green">‚Çπ{{ c.total_amount }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="empty">No civil bills</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- ================= DEPARTMENT ================= -->
  <section class="bill-card">
    <h3 class="bill-title text-orange-600">üè¢ Departments</h3>

    <table class="bill-table">
      <thead>
        <tr>
          <th class="text-left">Department</th>
          <th>Advance</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for d in dept_bills %}
        <tr class="row-click"
            onclick="openBill('dept', {{ d.department_id }}, '{{ d.department__name|escapejs }}')">
          <td class="link">{{ d.department__name }}</td>
          <td class="amount-red">‚Çπ{{ d.total_advance|default:0 }}</td>
          <td class="amount-green">‚Çπ{{ d.total_amount }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="empty">No department bills</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- ================= MATERIAL ================= -->
  <section class="bill-card">
    <h3 class="bill-title text-green-700">üß± Material Agents</h3>

    <table class="bill-table">
      <thead>
        <tr>
          <th class="text-left">Agent</th>
          <th>Advance</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for m in material_bills %}
        <tr class="row-click"
            onclick="openBill('material', '{{ m.agent_name|escapejs }}', '{{ m.agent_name|escapejs }}')">
          <td class="link">{{ m.agent_name }}</td>
          <td class="amount-red">‚Çπ{{ m.total_advance|default:0 }}</td>
          <td class="amount-green">‚Çπ{{ m.total_amount }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="empty">No material bills</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- ================= OTHER EXPENSE ================= -->
  <section class="bill-card bill-card-expense">
    <h3 class="bill-title text-purple-700">üí∏ Other Expenses</h3>

    <table class="bill-table">
      <thead>
        <tr>
          <th class="text-left">Expense</th>
          <th>Advance</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for e in expense_bills %}
        <tr class="row-click"
            onclick="openBill('expense', '{{ e.title|escapejs }}', '{{ e.title|escapejs }}')">
          <td class="link">{{ e.title }}</td>
          <td class="amount-red">‚Çπ{{ e.total_advance|default:0 }}</td>
          <td class="amount-green">‚Çπ{{ e.total_amount }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="3" class="empty">No other expenses</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

</div>

<!-- ================= MODAL ================= -->
<div id="billModal"
     class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm">

  <div class="bg-white rounded-2xl w-[92%] max-w-3xl p-6 shadow-2xl">

    <div class="flex justify-between items-center mb-4">
      <h3 id="modalTitle" class="font-bold text-lg"></h3>

      <div class="flex gap-3">
        <a id="pdfLink"
           target="_blank"
           class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded-lg font-bold text-sm shadow">
          üìÑ Download PDF
        </a>

        <button onclick="closeModal()"
                class="text-red-600 font-bold text-xl">
          ‚úï
        </button>
      </div>
    </div>

    <div class="modal-table-wrap">
  <table class="bill-table">
      <thead>
        <tr>
          <th>Site</th>
          <th>Owner</th>
          <th>Advance</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="modalBody"></tbody>
    </table>
  </div>
  </div>
</div>

<!-- ================= JS ================= -->
<script>
function openBill(type, id, title) {

  const modal = document.getElementById("billModal");
  const body  = document.getElementById("modalBody");
  const titleEl = document.getElementById("modalTitle");
  const pdfLink = document.getElementById("pdfLink");

  titleEl.innerText = title;
  body.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

  modal.classList.remove("hidden");
  modal.classList.add("flex");

  let apiUrl = "";
  let pdfUrl = "";

  if (type === "civil") {
    apiUrl = `/api/bill/civil/${id}/`;
    pdfUrl = `/bill/team/${id}/`;
  }

  if (type === "dept") {
    apiUrl = `/api/bill/department/${id}/`;
    pdfUrl = `/bill/department/${id}/`;
  }

  if (type === "material") {
    apiUrl = `/api/bill/material/${encodeURIComponent(id)}/`;
    pdfUrl = `/bill/agent/${encodeURIComponent(id)}/`;
  }

  if (type === "expense") {
    apiUrl = `/api/bill/expense/${encodeURIComponent(id)}/`;
    pdfUrl = `/bill/expense/${encodeURIComponent(id)}/`;
  }

  pdfLink.href = `${pdfUrl}?from_date={{ from_date|date:'Y-m-d' }}&to_date={{ to_date|date:'Y-m-d' }}&pdf=1`;

  fetch(`${apiUrl}?from_date={{ from_date|date:'Y-m-d' }}&to_date={{ to_date|date:'Y-m-d' }}`)
    .then(res => res.json())
    .then(data => {

      // üî• supports BOTH old + new API
      const rows = Array.isArray(data) ? data : (data.rows || []);
      const totals = data.team_total || {};

      if (!rows.length) {
        body.innerHTML = "<tr><td colspan='4'>No records</td></tr>";
        return;
      }

      let html = "";

      rows.forEach(r => {
        html += `
          <tr>
            <td>${r.site__name || r.site || '-'}</td>
            <td>${r.site__owner__name || '-'}</td>
            <td class="text-red-600">‚Çπ${r.advance ?? 0}</td>
            <td class="font-bold text-green-700">‚Çπ${r.total || 0}</td>
          </tr>
        `;
      });

      // team total (only if exists)
      if (totals && (totals.advance_total || totals.grand_total)) {
        html += `
          <tr class="bg-slate-100 font-extrabold">
            <td colspan="2">TEAM TOTAL</td>
            <td class="text-red-700 text-right">‚Çπ${totals.advance_total || 0}</td>
            <td class="text-green-800">‚Çπ${totals.grand_total || 0}</td>
          </tr>
        `;
      }

      body.innerHTML = html;
    })
    .catch(() => {
      body.innerHTML = "<tr><td colspan='4'>Error loading data</td></tr>";
    });
}

function closeModal(){
  const modal = document.getElementById("billModal");
  modal.classList.add("hidden");
  modal.classList.remove("flex");
}

document.getElementById("billModal").addEventListener("click", function (e) {
  if (e.target.id === "billModal") {
    closeModal();
  }
});



document.addEventListener("DOMContentLoaded", function () {

  const fromInput = document.querySelector("input[name='from_date']");
  const toInput   = document.querySelector("input[name='to_date']");

  if (!fromInput || !toInput) return; // safety

  const form = fromInput.closest("form");

  function autoSubmit(){
    form.submit();
  }

  fromInput.addEventListener("change", autoSubmit);
  toInput.addEventListener("change", autoSubmit);

});

</script>

<!-- ================= STYLES ================= -->
<style>
/* ================= BASE ================= */

.btn-soft-red{
  background:#fee2e2;
  color:#7f1d1d;
  padding:.5rem .9rem;
  border-radius:.7rem;
  font-weight:700;
}

.label{
  font-size:.7rem;
  font-weight:700;
  color:#64748b;
}

.input{
  border:1px solid #e5e7eb;
  border-radius:.6rem;
  padding:.5rem .7rem;
  font-size:.9rem;
  background:#fff;
}

.btn-primary{
  background:#2563eb;
  color:white;
  padding:.6rem 1.4rem;
  border-radius:.6rem;
  font-weight:800;
  box-shadow:0 6px 14px rgba(37,99,235,.25);
}

/* ================= BILL CARD ================= */

.bill-card{
  width:100%;
  background:white;
  border-radius:18px;
  padding:1.5rem;
  border:1px solid #e5e7eb;
  box-shadow:0 10px 25px rgba(0,0,0,.05);
  transition:.25s;
}

.bill-card:hover{
  transform:translateY(-2px);
  box-shadow:0 18px 40px rgba(0,0,0,.08);
}

.bill-card-expense{
  background:linear-gradient(180deg,#faf5ff,#ffffff);
}

.bill-title{
  font-size:1.15rem;
  font-weight:900;
  margin-bottom:1rem;
}

/* ================= TABLE ================= */

.bill-table{
  width:100%;
  table-layout:fixed;
  border-collapse:collapse;
  font-size:.92rem;
}

.bill-table thead th{
  font-size:.72rem;
  text-transform:uppercase;
  color:#475569;
  background:#f8fafc;
  padding:.75rem;
  border-bottom:1px solid #e5e7eb;
}

.bill-table td{
  padding:.8rem .75rem;
  border-bottom:1px solid #eef2f7;
  word-break:break-word;
}

/* column sizing (main tables) */
.bill-table th:nth-child(1),
.bill-table td:nth-child(1){
  width:50%;
  text-align:left;
}

.bill-table th:nth-child(2),
.bill-table td:nth-child(2){
  width:25%;
  text-align:right;
}

.bill-table th:nth-child(3),
.bill-table td:nth-child(3){
  width:25%;
  text-align:right;
}

/* ================= ROW STATES ================= */

.row-click{
  cursor:pointer;
  transition:.15s ease;
}

.row-click:hover{
  background:#f8fafc;
}

.link{
  color:#2563eb;
  font-weight:800;
}

.amount-red{
  color:#dc2626;
  font-weight:800;
}

.amount-green{
  color:#16a34a;
  font-weight:900;
}

.empty{
  text-align:center;
  color:#94a3b8;
  padding:1.2rem;
}

/* ================= MODAL ================= */

#billModal > div{
  width:92%;
  max-width:900px;
  min-width:320px;
  border-radius:18px;
}

/* scroll wrapper */
.modal-table-wrap{
  width:100%;
  overflow-x:auto;
}

/* modal table special sizing */
#billModal .bill-table{
  width:100%;
  table-layout:fixed;
  font-size:.9rem;
}

/* modal column widths */
#billModal .bill-table th:nth-child(1),
#billModal .bill-table td:nth-child(1){
  width:18%;
}

#billModal .bill-table th:nth-child(2),
#billModal .bill-table td:nth-child(2){
  width:22%;
  text-align:right;
}

#billModal .bill-table th:nth-child(3),
#billModal .bill-table td:nth-child(3){
  width:22%;
}

#billModal .bill-table th:nth-child(4),
#billModal .bill-table td:nth-child(4){
  width:19%;
  text-align:right;
}

#billModal .bill-table th:nth-child(5),
#billModal .bill-table td:nth-child(5){
  width:19%;
  text-align:right;
}

/* ================= MOBILE PERFECT ================= */

@media (max-width:640px){

  .bill-card{
    padding:1rem;
    border-radius:14px;
  }

  .bill-title{
    font-size:1rem;
  }

  .bill-table{
    font-size:.8rem;
  }

  .bill-table th,
  .bill-table td{
    padding:.55rem .45rem;
    white-space:nowrap;
  }

  .btn-primary{
    padding:.55rem 1rem;
    font-size:.85rem;
  }
}

/* ================= VERY SMALL MOBILE ================= */

@media (max-width:420px){

  .bill-table{
    font-size:.75rem;
  }

  .bill-table th{
    font-size:.65rem;
  }

  .input{
    font-size:.8rem;
  }
}
</style>

{% endblock %}